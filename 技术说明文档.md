# Relationship Management Backend - 技术说明文档

## 📋 目录

1. [项目概述](#项目概述)
2. [技术架构](#技术架构)
3. [核心功能模块](#核心功能模块)
4. [数据库设计](#数据库设计)
5. [安全机制](#安全机制)
6. [AI集成](#ai集成)
7. [API接口](#api接口)
8. [配置说明](#配置说明)
9. [部署指南](#部署指南)
10. [开发规范](#开发规范)

---

## 项目概述

### 项目信息
- **项目名称**: Relationship Management Backend (关系管理后端系统)
- **版本**: 0.0.1-SNAPSHOT
- **描述**: 一个基于AI驱动的关系管理系统，帮助用户更好地维护和改善人际关系
- **主要语言**: Java 17
- **构建工具**: Maven

### 核心价值
本系统通过AI技术辅助用户：
- 系统化管理个人联系人信息
- 通过对话式交互深度了解联系人
- 智能生成关系改善策略和行动计划
- 提供智能提醒和关系洞察
- 支持知识收藏和回顾

---

## 技术架构

### 技术栈

#### 后端框架
- **Spring Boot 3.5.6**: 主应用框架
- **Spring Security**: 安全认证和授权
- **Spring Data JPA**: 数据持久化层
- **Spring WebFlux**: 响应式HTTP客户端（用于AI调用）

#### 数据库
- **MySQL**: 生产环境数据库
- **H2**: 开发和测试环境内存数据库
- **Flyway**: 数据库版本管理和迁移

#### 安全与认证
- **JWT (JJWT 0.11.5)**: Token认证
- **BCrypt**: 密码加密
- **Firebase Admin SDK 9.2.0**: 推送通知服务

#### API文档
- **SpringDoc OpenAPI 2.6.0**: API文档生成（Swagger UI）

#### 工具库
- **Lombok**: 简化Java代码
- **Jakarta Validation**: 请求参数校验

#### 测试框架
- **JUnit 5**: 单元测试
- **Testcontainers**: 集成测试（MySQL容器）
- **Spring Security Test**: 安全测试

### 项目结构

```
com.ulog.backend
├── ai/                          # AI服务模块
│   ├── AiSummaryService         # AI摘要服务接口
│   ├── AiSummaryServiceImpl     # AI摘要服务实现
│   ├── DeepseekClient           # Deepseek API客户端
│   ├── DeepseekController       # Deepseek控制器
│   ├── DeepseekService          # Deepseek服务
│   ├── GoalAiService            # 目标AI服务
│   └── dto/                     # AI相关DTO
│
├── auth/                        # 认证模块
│   ├── controller/              # 认证控制器
│   ├── dto/                     # 认证DTO
│   └── service/                 # 认证服务
│
├── common/                      # 通用模块
│   ├── api/                     # 统一API响应
│   │   ├── ApiResponse          # 统一响应包装
│   │   └── ErrorCode            # 错误码定义
│   └── exception/               # 异常处理
│       ├── GlobalExceptionHandler
│       └── 各类自定义异常
│
├── config/                      # 配置模块
│   ├── SecurityConfig           # 安全配置
│   ├── CorsConfig              # CORS配置
│   ├── JwtProperties           # JWT属性
│   ├── DeepseekClientConfig    # Deepseek客户端配置
│   ├── FirebaseConfig          # Firebase配置
│   ├── OpenApiConfig           # API文档配置
│   └── TraceIdFilter           # 请求追踪过滤器
│
├── contact/                     # 联系人模块
│   ├── controller/              # 联系人控制器
│   ├── dto/                     # 联系人DTO
│   └── service/                 # 联系人服务
│       ├── ContactService       # 联系人CRUD
│       └── AibookService        # AI洞察服务
│
├── conversation/                # 对话模块
│   ├── controller/              # 对话控制器
│   ├── dto/                     # 对话DTO
│   ├── enums/                   # 枚举类
│   ├── service/                 # 对话服务
│   │   ├── InfoCollectionService     # 联系人信息收集
│   │   ├── UserInfoCollectionService # 用户信息收集
│   │   ├── InfoSupplementService     # 信息补充
│   │   ├── QaService                 # 联系人问答
│   │   ├── UserQaService             # 用户问答
│   │   └── QaHistoryService          # 问答历史
│   └── util/
│       └── PromptTemplates      # AI提示词模板
│
├── domain/                      # 领域模型
│   ├── contact/                 # 联系人实体
│   ├── conversation/            # 对话会话实体
│   ├── goal/                    # 目标相关实体
│   ├── pin/                     # Pin收藏实体
│   ├── token/                   # Token实体
│   └── user/                    # 用户实体
│
├── goal/                        # 目标管理模块
│   ├── controller/              # 目标控制器
│   ├── dto/                     # 目标DTO
│   └── service/                 # 目标服务
│       ├── GoalService          # 目标管理
│       ├── ActionPlanService    # 行动计划
│       └── ReminderService      # 提醒服务
│
├── pin/                         # Pin收藏模块
│   ├── controller/              # Pin控制器
│   ├── dto/                     # Pin DTO
│   └── service/                 # Pin服务
│
├── push/                        # 推送通知模块
│   ├── controller/              # 推送控制器
│   ├── PushNotificationService  # 推送服务
│   └── PushTokenService         # Token管理
│
├── repository/                  # 数据访问层
│   ├── UserRepository
│   ├── ContactRepository
│   ├── ConversationSessionRepository
│   ├── UserConversationSessionRepository
│   ├── RelationshipGoalRepository
│   ├── ActionPlanRepository
│   ├── ReminderRepository
│   ├── PinRepository
│   ├── RefreshTokenRepository
│   └── UserPushTokenRepository
│
├── security/                    # 安全模块
│   ├── JwtTokenProvider         # JWT生成和验证
│   ├── JwtAuthenticationFilter  # JWT认证过滤器
│   ├── CustomUserDetailsService # 用户详情服务
│   └── UserPrincipal           # 用户主体
│
├── user/                        # 用户模块
│   ├── controller/              # 用户控制器
│   ├── dto/                     # 用户DTO
│   └── service/                 # 用户服务
│
├── util/                        # 工具类
│   ├── E164Phone               # 国际电话号码验证
│   ├── E164PhoneValidator      # 电话号码验证器
│   └── RateLimiterService      # 限流服务
│
└── BackendApplication.java      # 主应用入口
```

---

## 核心功能模块

### 1. 用户认证与授权模块 (auth)

#### 功能特性
- ✅ 基于手机号的用户注册
- ✅ 密码登录（BCrypt加密）
- ✅ JWT双Token机制（Access Token + Refresh Token）
- ✅ Token刷新和登出
- ✅ 账户锁定机制（防暴力破解）

#### 技术实现
```java
// JWT配置
- Access Token有效期: 15分钟
- Refresh Token有效期: 14天
- 使用RS256算法签名
- 密码强度: BCrypt 12轮加密
```

#### 安全特性
- 密码错误累计锁定（5次失败锁定30分钟）
- 自动Token过期管理
- 跨域请求保护
- 无状态会话管理

### 2. 联系人管理模块 (contact)

#### 功能特性
- ✅ 联系人CRUD操作
- ✅ 联系人信息AI摘要生成
- ✅ 关系洞察（Aibook）生成
- ✅ 联系人搜索和分页

#### AI功能
- **AI Summary**: 基于对话历史自动生成联系人特征摘要
- **Aibook**: 深度分析联系人关系，生成关系洞察报告

### 3. 对话管理模块 (conversation)

这是系统的核心模块，通过对话式交互收集和管理信息。

#### 3.1 联系人信息收集 (InfoCollectionService)

**功能**: 通过多轮对话收集联系人的详细信息

**流程**:
```
1. 开始收集 → 创建会话
2. AI提问 → 用户回答
3. 信息提取 → 结构化存储
4. 判断完整性 → 继续或结束
5. 生成摘要 → 更新联系人
```

**AI能力**:
- 自然对话引导
- 自动信息提取
- 收集完整性判断
- 智能摘要生成

#### 3.2 用户信息收集 (UserInfoCollectionService)

**功能**: 收集用户自身的价值观、性格特征等信息

**收集维度**:
- 基本信息（年龄、职业、兴趣）
- 价值观（重要的价值观念）
- 性格特征（MBTI、五大人格等）
- 生活方式偏好

#### 3.3 联系人问答系统 (QaService)

**功能**: 基于联系人信息的智能问答

**特性**:
- 上下文感知对话
- 信息补充机制
- 问答历史记录
- 支持Pin收藏

**补充信息流程**:
```
用户提问 → AI判断信息是否足够
    ├─ 足够: 直接回答
    └─ 不足: 反问用户补充 → 用户回答 → 生成完整答案
```

#### 3.4 用户自我问答 (UserQaService)

**功能**: 帮助用户自我认知和成长

**应用场景**:
- 自我反思
- 价值观澄清
- 决策辅助
- 个人成长建议

### 4. 关系目标管理模块 (goal)

#### 功能架构

```
关系目标
  ├─ AI策略生成
  ├─ 行动计划列表
  │   ├─ 计划1 (已采纳)
  │   ├─ 计划2 (未采纳)
  │   └─ 计划3 (已完成)
  └─ 提醒系统
      ├─ 自动创建提醒
      ├─ 定时发送推送
      └─ 提醒状态跟踪
```

#### 核心流程

**1. 创建目标**
```http
POST /api/goals
{
  "contactId": 1,
  "goalDescription": "希望能够和这个联系人建立更深厚的友谊"
}
```

**返回**:
- AI生成的策略建议
- 3-5个具体行动计划
- 每个计划包含标题、描述、建议时间

**2. 采纳管理**
```http
PUT /api/goals/{goalId}/plans/{planId}/adopt
```
- 用户可选择性采纳AI建议
- 只有已采纳的计划才会创建提醒

**3. 状态跟踪**
- PENDING: 待执行
- IN_PROGRESS: 执行中
- COMPLETED: 已完成
- SKIPPED: 已跳过

**4. 推送提醒**
- 自动在计划时间前15分钟提醒
- 通过FCM推送到用户设备
- 支持iOS和Android

### 5. Pin收藏模块 (pin)

#### 功能概述
将对话中的重要QA收藏起来，方便日后查看和回顾。

#### 数据结构
```java
Pin {
  - sourceType: CONTACT_QA / USER_QA
  - sessionId: 来源会话ID
  - qaIndex: QA在历史中的索引
  - contactId: 关联联系人（可选）
  - question: 用户问题
  - answer: AI回答
  - supplementQuestion: 补充问题（可选）
  - supplementAnswer: 补充回答（可选）
  - contextInfo: 上下文元数据（JSON）
  - note: 用户备注
  - tags: 标签
}
```

#### 主要功能
- ✅ 收藏QA对话
- ✅ 添加备注和标签
- ✅ 按联系人筛选
- ✅ 按来源类型筛选
- ✅ 防重复收藏

### 6. 推送通知模块 (push)

#### 技术实现
- **服务**: Firebase Cloud Messaging (FCM)
- **支持平台**: iOS、Android
- **推送类型**: 行动计划提醒

#### 核心功能
```java
// 注册设备Token
POST /api/push/register
{
  "deviceToken": "fcm-token",
  "deviceType": "iOS"
}

// 发送推送
pushNotificationService.sendReminder(userId, title, body, data)
```

#### 定时任务
```java
@Scheduled(cron = "0 * * * * *")  // 每分钟执行
public void checkAndSendReminders() {
  // 查询需要发送的提醒
  // 发送推送通知
  // 更新提醒状态
}
```

---

## 数据库设计

### 数据库版本历史

系统使用Flyway进行数据库版本管理，当前共6个版本：

| 版本 | 文件名 | 说明 |
|------|--------|------|
| V1 | V1__init.sql | 初始化（用户、联系人、Token） |
| V2 | V2__create_conversation_sessions.sql | 联系人对话会话 |
| V3 | V3__create_user_conversation_sessions.sql | 用户自我对话会话 |
| V4 | V4__add_qa_history_and_self_value.sql | QA历史和用户价值观 |
| V5 | V5__create_relationship_goals.sql | 关系目标和行动计划 |
| V6 | V6__create_pins.sql | Pin收藏功能 |

### 核心数据表

#### 1. users (用户表)
```sql
CREATE TABLE users (
    uid BIGINT AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(32) NOT NULL UNIQUE,         -- 手机号（唯一）
    password_hash VARCHAR(255) NOT NULL,       -- 密码哈希
    name VARCHAR(64) NOT NULL,                 -- 用户名
    description VARCHAR(512),                  -- 自我描述
    ai_summary VARCHAR(1024),                  -- AI生成的用户摘要
    status TINYINT NOT NULL DEFAULT 1,         -- 状态
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted TINYINT DEFAULT 0,
    failed_attempts INT NOT NULL DEFAULT 0,    -- 登录失败次数
    last_failed_at DATETIME,                   -- 最后失败时间
    locked_until DATETIME                      -- 锁定到期时间
) ENGINE = InnoDB;
```

#### 2. contacts (联系人表)
```sql
CREATE TABLE contacts (
    cid BIGINT AUTO_INCREMENT PRIMARY KEY,
    owner_uid BIGINT NOT NULL,                 -- 所有者用户ID
    name VARCHAR(128) NOT NULL,                -- 联系人名称
    description VARCHAR(1024),                 -- 描述
    ai_summary VARCHAR(2048),                  -- AI生成的摘要
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted TINYINT DEFAULT 0,
    FOREIGN KEY (owner_uid) REFERENCES users(uid)
) ENGINE = InnoDB;
```

#### 3. conversation_sessions (联系人对话会话)
```sql
CREATE TABLE conversation_sessions (
    session_id VARCHAR(100) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    contact_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL,               -- ACTIVE/COMPLETED
    qa_history TEXT,                           -- QA历史（JSON）
    extraction_result TEXT,                    -- 提取的信息（JSON）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(uid),
    FOREIGN KEY (contact_id) REFERENCES contacts(cid)
) ENGINE = InnoDB;
```

#### 4. user_conversation_sessions (用户自我对话会话)
```sql
CREATE TABLE user_conversation_sessions (
    session_id VARCHAR(100) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL,
    qa_history TEXT,
    self_value TEXT,                           -- 用户价值观（JSON）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(uid)
) ENGINE = InnoDB;
```

#### 5. relationship_goals (关系目标表)
```sql
CREATE TABLE relationship_goals (
    goal_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    contact_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    goal_description TEXT NOT NULL,            -- 目标描述
    ai_strategy TEXT,                          -- AI生成的策略
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted TINYINT DEFAULT 0,
    FOREIGN KEY (contact_id) REFERENCES contacts(cid),
    FOREIGN KEY (user_id) REFERENCES users(uid)
) ENGINE = InnoDB;
```

#### 6. action_plans (行动计划表)
```sql
CREATE TABLE action_plans (
    plan_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    goal_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,               -- 计划标题
    description TEXT,                          -- 计划描述
    scheduled_time DATETIME NOT NULL,          -- 计划执行时间
    is_adopted TINYINT NOT NULL DEFAULT 1,     -- 是否采纳
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    completed_at DATETIME,
    order_index INT NOT NULL DEFAULT 0,        -- 排序索引
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted TINYINT DEFAULT 0,
    FOREIGN KEY (goal_id) REFERENCES relationship_goals(goal_id) ON DELETE CASCADE
) ENGINE = InnoDB;
```

#### 7. reminders (提醒表)
```sql
CREATE TABLE reminders (
    reminder_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    plan_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    remind_time DATETIME NOT NULL,             -- 提醒时间
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    sent_at DATETIME,                          -- 发送时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (plan_id) REFERENCES action_plans(plan_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(uid)
) ENGINE = InnoDB;
```

#### 8. pins (Pin收藏表)
```sql
CREATE TABLE pins (
    pin_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    source_type VARCHAR(20) NOT NULL,          -- CONTACT_QA/USER_QA
    session_id VARCHAR(100) NOT NULL,
    qa_index INT NOT NULL,                     -- QA索引
    contact_id BIGINT NULL,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    supplement_question TEXT,
    supplement_answer TEXT,
    needs_more_info TINYINT DEFAULT 0,
    context_info TEXT,                         -- 上下文（JSON）
    note VARCHAR(500),                         -- 用户备注
    tags VARCHAR(255),                         -- 标签
    qa_timestamp VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(uid) ON DELETE CASCADE,
    FOREIGN KEY (contact_id) REFERENCES contacts(cid) ON DELETE SET NULL,
    UNIQUE KEY uk_user_session_qa (user_id, session_id, qa_index)
) ENGINE = InnoDB;
```

#### 9. user_push_tokens (推送Token表)
```sql
CREATE TABLE user_push_tokens (
    token_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    device_token VARCHAR(512) NOT NULL,        -- FCM设备Token
    device_type VARCHAR(20) NOT NULL,          -- iOS/Android
    is_active TINYINT NOT NULL DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(uid),
    UNIQUE KEY uk_device_token (device_token)
) ENGINE = InnoDB;
```

#### 10. refresh_tokens (刷新Token表)
```sql
CREATE TABLE refresh_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token VARCHAR(512) NOT NULL UNIQUE,
    expires_at DATETIME NOT NULL,
    revoked TINYINT NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(uid)
) ENGINE = InnoDB;
```

### 数据库索引策略

```sql
-- 联系人
CREATE INDEX idx_contacts_owner ON contacts(owner_uid);

-- 目标
CREATE INDEX idx_goals_user ON relationship_goals(user_id);
CREATE INDEX idx_goals_contact ON relationship_goals(contact_id);
CREATE INDEX idx_goals_status ON relationship_goals(status);

-- 行动计划
CREATE INDEX idx_action_plans_goal ON action_plans(goal_id);
CREATE INDEX idx_action_plans_status ON action_plans(status);
CREATE INDEX idx_action_plans_scheduled ON action_plans(scheduled_time);

-- 提醒
CREATE INDEX idx_reminders_plan ON reminders(plan_id);
CREATE INDEX idx_reminders_user ON reminders(user_id);
CREATE INDEX idx_reminders_time_status ON reminders(remind_time, status);

-- Pin
CREATE INDEX idx_pins_user ON pins(user_id);
CREATE INDEX idx_pins_source_type ON pins(source_type);
CREATE INDEX idx_pins_contact ON pins(contact_id);
CREATE INDEX idx_pins_created ON pins(created_at);
CREATE INDEX idx_pins_user_contact ON pins(user_id, contact_id);

-- 推送Token
CREATE INDEX idx_push_tokens_user ON user_push_tokens(user_id);
CREATE INDEX idx_push_tokens_active ON user_push_tokens(is_active);
```

---

## 安全机制

### 1. 认证流程

```
用户登录请求
    ↓
验证手机号和密码
    ↓
检查账户锁定状态
    ↓
生成Access Token (15分钟)
生成Refresh Token (14天)
    ↓
返回双Token
    ↓
后续请求携带Access Token
    ↓
JWT过滤器验证Token
    ↓
提取用户信息到SecurityContext
    ↓
访问受保护资源
```

### 2. JWT Token结构

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "userId",
    "iat": 1234567890,
    "exp": 1234568790
  },
  "signature": "..."
}
```

### 3. 安全配置

#### 密码策略
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder(12);  // 12轮加密
}
```

#### 账户锁定策略
```java
// 配置
MAX_FAILED_ATTEMPTS = 5
LOCK_DURATION_MINUTES = 30

// 逻辑
if (failedAttempts >= 5) {
    lockUntil = now + 30 minutes
}
```

#### CORS配置
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        // 允许的源、方法、头部
        // 支持凭证
        // 最大缓存时间
    }
}
```

### 4. 接口权限

#### 公开接口
```java
- POST /api/v1/auth/register    // 注册
- POST /api/v1/auth/login       // 登录
- POST /api/v1/auth/refresh     // 刷新Token
- POST /api/v1/auth/logout      // 登出
- GET  /swagger-ui/**           // API文档
- GET  /v3/api-docs/**          // OpenAPI规范
```

#### 受保护接口
```java
// 所有其他接口都需要JWT认证
Authorization: Bearer <access_token>
```

### 5. 限流保护

```java
@Service
public class RateLimiterService {
    // 基于内存的限流实现
    // 可防止API滥用
}
```

### 6. 输入验证

```java
// 使用Jakarta Validation
@NotNull
@NotBlank
@Size(min = 1, max = 100)
@Email
@E164Phone  // 自定义电话号码验证
```

---

## AI集成

### DeepSeek API集成

#### 配置
```properties
deepseek.base-url=https://api.deepseek.com
deepseek.api-key=${DEEPSEEK_API_KEY}
deepseek.model=deepseek-chat
deepseek.reasoner-model=deepseek-reasoner
deepseek.timeout-ms=120000
deepseek.enable-logging=true
```

#### 客户端实现
```java
@Service
public class DeepseekClient {
    private final WebClient webClient;
    
    public Mono<ChatCompletionResponse> chatCompletion(
        ChatCompletionRequest request
    ) {
        return webClient.post()
            .uri("/chat/completions")
            .header("Authorization", "Bearer " + apiKey)
            .bodyValue(request)
            .retrieve()
            .bodyToMono(ChatCompletionResponse.class);
    }
}
```

### AI提示词工程

系统使用精心设计的Prompt模板实现各种AI功能：

#### 1. 信息收集Prompt
```java
public class PromptTemplates {
    public static String INFO_COLLECTION_SYSTEM = """
        你是一个善于倾听和提问的AI助手...
        目标：通过自然对话收集联系人信息
        要求：
        1. 一次只问一个问题
        2. 根据已有信息调整问题
        3. 保持对话自然流畅
        """;
}
```

#### 2. 信息提取Prompt
```java
public static String EXTRACTION_PROMPT = """
    从用户回答中提取结构化信息
    返回JSON格式：
    {
      "name": "姓名",
      "age": 年龄,
      "occupation": "职业",
      "interests": ["兴趣1", "兴趣2"],
      ...
    }
    """;
```

#### 3. 判断完整性Prompt
```java
public static String COMPLETION_CHECK = """
    判断收集的信息是否足够完整
    返回：
    {
      "isComplete": true/false,
      "confidence": "HIGH/MEDIUM/LOW",
      "missingFields": ["缺少的字段"]
    }
    """;
```

#### 4. 关系策略生成Prompt
```java
public static String GOAL_STRATEGY = """
    基于以下信息生成关系改善策略：
    - 联系人信息：...
    - 用户目标：...
    - 当前关系状态：...
    
    返回：
    {
      "strategy": "策略描述",
      "actionPlans": [
        {
          "title": "行动标题",
          "description": "详细描述",
          "suggestedTime": "建议时间"
        }
      ]
    }
    """;
```

### AI功能矩阵

| 功能 | 使用场景 | AI模型 | 返回格式 |
|------|---------|--------|---------|
| 信息收集 | 对话引导 | deepseek-chat | 自然语言 |
| 信息提取 | 结构化存储 | deepseek-chat | JSON |
| 完整性判断 | 会话控制 | deepseek-chat | JSON |
| 摘要生成 | 信息总结 | deepseek-chat | 自然语言 |
| 问答系统 | 用户提问 | deepseek-chat | 自然语言 |
| 关系洞察 | Aibook生成 | deepseek-chat | 结构化文本 |
| 目标策略 | 行动计划 | deepseek-chat | JSON |

---

## API接口

### 统一响应格式

#### 成功响应
```json
{
  "success": true,
  "code": 200,
  "message": "Success",
  "data": { ... },
  "timestamp": "2025-10-19T12:00:00"
}
```

#### 错误响应
```json
{
  "success": false,
  "code": 400,
  "message": "Invalid input",
  "data": null,
  "timestamp": "2025-10-19T12:00:00"
}
```

### 错误码定义

```java
public enum ErrorCode {
    // 通用错误 (1000-1999)
    SUCCESS(200, "Success"),
    BAD_REQUEST(400, "Bad Request"),
    UNAUTHORIZED(401, "Unauthorized"),
    FORBIDDEN(403, "Forbidden"),
    NOT_FOUND(404, "Not Found"),
    INTERNAL_ERROR(500, "Internal Server Error"),
    
    // 认证错误 (2000-2099)
    AUTH_INVALID_CREDENTIALS(2001, "Invalid credentials"),
    AUTH_TOKEN_EXPIRED(2002, "Token expired"),
    AUTH_TOKEN_INVALID(2003, "Invalid token"),
    AUTH_USER_LOCKED(2004, "Account locked"),
    AUTH_PHONE_EXISTS(2005, "Phone already registered"),
    
    // 业务错误 (3000+)
    CONTACT_NOT_FOUND(3001, "Contact not found"),
    SESSION_NOT_FOUND(3002, "Session not found"),
    GOAL_NOT_FOUND(3003, "Goal not found"),
    RATE_LIMIT_EXCEEDED(3004, "Rate limit exceeded"),
    ...
}
```

### API版本管理

```
基础路径: /api/v1
版本策略: URL版本控制
当前版本: v1
```

### 核心API端点

#### 认证相关
```http
POST   /api/v1/auth/register          # 注册
POST   /api/v1/auth/login             # 登录
POST   /api/v1/auth/refresh           # 刷新Token
POST   /api/v1/auth/logout            # 登出
```

#### 用户相关
```http
GET    /api/v1/users/me               # 获取当前用户信息
PUT    /api/v1/users/me               # 更新用户信息
PUT    /api/v1/users/me/password      # 修改密码
DELETE /api/v1/users/me               # 删除账户
```

#### 联系人相关
```http
POST   /api/contacts                  # 创建联系人
GET    /api/contacts                  # 获取联系人列表
GET    /api/contacts/{id}             # 获取联系人详情
PUT    /api/contacts/{id}             # 更新联系人
DELETE /api/contacts/{id}             # 删除联系人
POST   /api/contacts/{id}/aibook      # 生成关系洞察
POST   /api/contacts/aibook/preview   # 预览Aibook
```

#### 对话相关
```http
# 联系人信息收集
POST   /api/conversations/start                    # 开始收集
POST   /api/conversations/{sessionId}/message      # 发送消息
GET    /api/conversations/{sessionId}/history      # 获取历史

# 联系人问答
POST   /api/qa/start                               # 开始问答
POST   /api/qa/{sessionId}/ask                     # 提问
POST   /api/qa/{sessionId}/supplement              # 补充信息
GET    /api/qa/{sessionId}/history                 # 获取历史

# 用户自我对话
POST   /api/user-conversations/start               # 开始收集
POST   /api/user-conversations/{sessionId}/message # 发送消息
POST   /api/user-qa/start                          # 开始问答
POST   /api/user-qa/{sessionId}/ask                # 提问
```

#### 目标相关
```http
POST   /api/goals                                  # 创建目标
GET    /api/goals                                  # 获取目标列表
GET    /api/goals/{goalId}                         # 获取目标详情
DELETE /api/goals/{goalId}                         # 删除目标

# 行动计划
PUT    /api/goals/{goalId}/plans/{planId}/adopt    # 采纳计划
PUT    /api/goals/{goalId}/plans/{planId}/unadopt  # 取消采纳
PUT    /api/goals/{goalId}/plans/{planId}/status   # 更新状态
PUT    /api/goals/{goalId}/plans/{planId}/time     # 修改时间
```

#### Pin相关
```http
POST   /api/pins                      # 创建Pin
GET    /api/pins                      # 获取Pin列表
GET    /api/pins/{pinId}              # 获取Pin详情
PUT    /api/pins/{pinId}              # 更新Pin
DELETE /api/pins/{pinId}              # 删除Pin
```

#### 推送相关
```http
POST   /api/push/register             # 注册设备Token
DELETE /api/push/unregister           # 注销设备Token
```

### API文档

系统集成了Swagger UI，可通过以下地址访问：

```
Swagger UI: http://localhost:8080/swagger-ui
OpenAPI Spec: http://localhost:8080/v3/api-docs
```

---

## 配置说明

### 环境配置

系统支持多环境配置：

- `application.properties` - 默认配置
- `application-dev.properties` - 开发环境
- `application-prod.properties` - 生产环境（需创建）
- `application-test.properties` - 测试环境

### 环境变量

#### 必需环境变量
```bash
# 数据库
DB_USERNAME=your_db_username
DB_PASSWORD=your_db_password

# JWT
JWT_SECRET=your_secure_secret_key_at_least_32_chars

# DeepSeek API
DEEPSEEK_API_KEY=your_deepseek_api_key

# Firebase (推送通知)
FIREBASE_CONFIG_PATH=/path/to/firebase-service-account.json
```

#### 可选环境变量
```bash
# 服务器
SERVER_PORT=8080

# 数据库URL
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/relationship_app

# 日志级别
LOGGING_LEVEL_ROOT=INFO
```

### 开发环境配置 (application-dev.properties)

```properties
# H2内存数据库
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# JPA
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=false

# Flyway
spring.flyway.enabled=true

# JWT
security.jwt.access-token-validity-minutes=15
security.jwt.refresh-token-validity-days=14

# DeepSeek
deepseek.timeout-ms=120000
deepseek.enable-logging=true

# 提醒
reminder.advance-minutes=15
reminder.scheduler.cron=0 * * * * *
```

### 生产环境配置建议

```properties
# 使用环境变量
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

# 关闭SQL日志
spring.jpa.show-sql=false

# 生产级别日志
logging.level.root=WARN
logging.level.com.ulog.backend=INFO

# 数据库连接池
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000

# 生产环境JWT
security.jwt.access-token-validity-minutes=15
security.jwt.refresh-token-validity-days=14
```

---

## 部署指南

### 1. 前置要求

#### 系统要求
- Java 17+
- Maven 3.6+
- MySQL 8.0+

#### 外部服务
- DeepSeek API账户和密钥
- Firebase项目和服务账户密钥
- （可选）反向代理（Nginx）

### 2. 数据库准备

```sql
-- 创建数据库
CREATE DATABASE relationship_app 
  CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'ulog'@'localhost' IDENTIFIED BY 'your_password';

-- 授权
GRANT ALL PRIVILEGES ON relationship_app.* TO 'ulog'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 构建项目

```bash
# 克隆项目
git clone <repository-url>
cd backend

# 配置环境变量
export DB_USERNAME=ulog
export DB_PASSWORD=your_password
export JWT_SECRET=your_secure_secret_key_minimum_32_characters
export DEEPSEEK_API_KEY=sk-your-key
export FIREBASE_CONFIG_PATH=/path/to/firebase-service-account.json

# 构建
mvn clean package -DskipTests

# 输出位置
# target/backend-0.0.1-SNAPSHOT.jar
```

### 4. 运行应用

#### 开发模式
```bash
# 使用Maven
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 或使用jar
java -jar target/backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev
```

#### 生产模式
```bash
java -jar \
  -Dspring.profiles.active=prod \
  -Xms512m \
  -Xmx2g \
  target/backend-0.0.1-SNAPSHOT.jar
```

### 5. 使用Docker部署

#### Dockerfile
```dockerfile
FROM openjdk:17-slim

WORKDIR /app

COPY target/backend-0.0.1-SNAPSHOT.jar app.jar

EXPOSE 8080

ENV JAVA_OPTS="-Xms512m -Xmx2g"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: relationship_app
      MYSQL_USER: ulog
      MYSQL_PASSWORD: password
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql

  backend:
    build: .
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://mysql:3306/relationship_app
      DB_USERNAME: ulog
      DB_PASSWORD: password
      JWT_SECRET: ${JWT_SECRET}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      FIREBASE_CONFIG_PATH: /app/config/firebase-service-account.json
    volumes:
      - ./firebase-service-account.json:/app/config/firebase-service-account.json
    depends_on:
      - mysql

volumes:
  mysql-data:
```

### 6. Nginx反向代理配置

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 7. 健康检查

```bash
# 检查应用状态
curl http://localhost:8080/actuator/health

# 检查数据库连接
curl http://localhost:8080/actuator/health/db
```

### 8. 日志管理

```bash
# 日志文件位置
logs/application.log

# 查看实时日志
tail -f logs/application.log

# 搜索错误
grep "ERROR" logs/application.log
```

---

## 开发规范

### 代码结构规范

#### 包命名规范
```
com.ulog.backend
  ├── domain/          # 领域模型（实体）
  ├── repository/      # 数据访问层
  ├── service/         # 业务逻辑层
  ├── controller/      # 控制器层
  ├── dto/             # 数据传输对象
  ├── config/          # 配置类
  ├── security/        # 安全相关
  ├── util/            # 工具类
  └── exception/       # 异常类
```

#### 实体类规范
```java
@Entity
@Table(name = "users")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long uid;
    
    // 字段
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    // 软删除
    @Column(name = "deleted")
    private Boolean deleted = false;
}
```

#### 服务类规范
```java
public interface UserService {
    User createUser(CreateUserRequest request);
    User getUserById(Long id);
    User updateUser(Long id, UpdateUserRequest request);
    void deleteUser(Long id);
}

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    
    @Override
    @Transactional
    public User createUser(CreateUserRequest request) {
        // 实现
    }
}
```

#### 控制器规范
```java
@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
@Tag(name = "User", description = "用户管理API")
public class UserController {
    
    private final UserService userService;
    
    @GetMapping("/{id}")
    @Operation(summary = "获取用户信息")
    public ApiResponse<UserResponse> getUser(
        @PathVariable Long id
    ) {
        User user = userService.getUserById(id);
        return ApiResponse.success(toResponse(user));
    }
}
```

### 命名规范

#### 类命名
```
实体类:     User, Contact, Goal
DTO:        UserRequest, UserResponse, CreateUserRequest
Service:    UserService, UserServiceImpl
Controller: UserController
Repository: UserRepository
```

#### 方法命名
```
查询:  getXxx, findXxx, listXxx, queryXxx
创建:  createXxx, addXxx
更新:  updateXxx, modifyXxx
删除:  deleteXxx, removeXxx
判断:  isXxx, hasXxx, canXxx
```

### 异常处理规范

```java
// 自定义异常
@Getter
public class ApiException extends RuntimeException {
    private final ErrorCode errorCode;
    
    public ApiException(ErrorCode errorCode) {
        super(errorCode.getMessage());
        this.errorCode = errorCode;
    }
}

// 全局异常处理
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(ApiException.class)
    public ApiResponse<?> handleApiException(ApiException e) {
        return ApiResponse.error(e.getErrorCode());
    }
    
    @ExceptionHandler(Exception.class)
    public ApiResponse<?> handleException(Exception e) {
        log.error("Unexpected error", e);
        return ApiResponse.error(ErrorCode.INTERNAL_ERROR);
    }
}
```

### 日志规范

```java
@Slf4j
public class SomeService {
    
    public void someMethod() {
        log.info("Starting process for user: {}", userId);
        
        try {
            // 业务逻辑
            log.debug("Processing step 1");
            
        } catch (Exception e) {
            log.error("Error processing user: {}", userId, e);
            throw new ApiException(ErrorCode.INTERNAL_ERROR);
        }
        
        log.info("Process completed successfully");
    }
}
```

### Git提交规范

```
feat:     新功能
fix:      修复bug
docs:     文档更新
style:    代码格式调整
refactor: 重构
test:     测试相关
chore:    构建/工具变动

示例:
feat: 添加关系目标管理功能
fix: 修复JWT token过期判断逻辑
docs: 更新API文档
refactor: 重构用户认证流程
```

### 测试规范

```java
@SpringBootTest
@Transactional
class UserServiceTest extends AbstractIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    @DisplayName("创建用户 - 成功")
    void testCreateUser_Success() {
        // Given
        CreateUserRequest request = new CreateUserRequest();
        request.setPhone("+8613800138000");
        request.setPassword("Password123");
        
        // When
        User user = userService.createUser(request);
        
        // Then
        assertNotNull(user.getUid());
        assertEquals(request.getPhone(), user.getPhone());
    }
    
    @Test
    @DisplayName("创建用户 - 手机号重复")
    void testCreateUser_DuplicatePhone() {
        // Given
        // 准备测试数据
        
        // When & Then
        assertThrows(ApiException.class, () -> {
            userService.createUser(request);
        });
    }
}
```

---

## 性能优化建议

### 1. 数据库优化

```sql
-- 添加合适的索引
CREATE INDEX idx_user_phone ON users(phone);
CREATE INDEX idx_contact_owner ON contacts(owner_uid, deleted);

-- 定期清理软删除数据
DELETE FROM contacts WHERE deleted = 1 AND updated_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 使用数据库连接池
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
```

### 2. 缓存策略

```java
// 可添加Redis缓存
@Cacheable(value = "users", key = "#id")
public User getUserById(Long id) {
    return userRepository.findById(id)
        .orElseThrow(() -> new NotFoundException("User not found"));
}

@CacheEvict(value = "users", key = "#id")
public void updateUser(Long id, UpdateUserRequest request) {
    // 更新逻辑
}
```

### 3. 异步处理

```java
@Async
public CompletableFuture<Void> sendPushNotification(
    Long userId, String title, String body
) {
    // 异步发送推送
    return CompletableFuture.completedFuture(null);
}
```

### 4. 批量操作

```java
// 批量插入
@Transactional
public void createReminders(List<Reminder> reminders) {
    reminderRepository.saveAll(reminders);
}
```

---

## 监控和维护

### 1. 应用监控

```properties
# 启用Actuator
management.endpoints.web.exposure.include=health,info,metrics

# 端点
/actuator/health     # 健康检查
/actuator/info       # 应用信息
/actuator/metrics    # 指标监控
```

### 2. 日志监控

```bash
# 查看错误日志
tail -f logs/application.log | grep ERROR

# 查看慢查询
tail -f logs/application.log | grep "took longer than"
```

### 3. 数据库维护

```sql
-- 检查表大小
SELECT 
  table_name,
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES 
WHERE table_schema = "relationship_app"
ORDER BY (data_length + index_length) DESC;

-- 优化表
OPTIMIZE TABLE users, contacts, conversation_sessions;
```

### 4. 备份策略

```bash
# 数据库备份
mysqldump -u root -p relationship_app > backup_$(date +%Y%m%d).sql

# 自动备份脚本
0 2 * * * /path/to/backup.sh
```

---

## 扩展功能建议

### 未来可能的功能扩展

1. **关系网络图谱**
   - 可视化联系人关系网络
   - 关系强度分析
   - 社交圈子划分

2. **智能提醒优化**
   - 基于用户习惯的智能提醒时间
   - 提醒效果追踪
   - 自适应提醒频率

3. **数据分析和报告**
   - 关系质量趋势分析
   - 互动频率统计
   - 个人关系健康度评分

4. **多端同步**
   - 实时消息同步
   - 离线数据缓存
   - 冲突解决机制

5. **社交功能**
   - 关系建议推荐
   - 经验分享社区
   - 匿名咨询功能

6. **高级AI功能**
   - 情感分析
   - 性格匹配度分析
   - 沟通风格建议

---

## 常见问题 (FAQ)

### Q1: 如何重置JWT密钥？
```bash
# 生成新的密钥
openssl rand -base64 32

# 更新环境变量
export JWT_SECRET=new_secret_key

# 重启应用
```

### Q2: 数据库迁移失败怎么办？
```sql
-- 查看Flyway历史
SELECT * FROM flyway_schema_history;

-- 修复失败的迁移
DELETE FROM flyway_schema_history WHERE success = 0;

-- 重新运行应用
```

### Q3: 如何清理过期的RefreshToken？
```java
@Scheduled(cron = "0 0 2 * * *")  // 每天凌晨2点
public void cleanExpiredTokens() {
    refreshTokenRepository.deleteByExpiresAtBefore(LocalDateTime.now());
}
```

### Q4: DeepSeek API调用超时怎么办？
```properties
# 增加超时时间
deepseek.timeout-ms=180000  # 3分钟

# 添加重试机制
@Retry(maxAttempts = 3, backoff = @Backoff(delay = 1000))
```

### Q5: 如何更换数据库？
```properties
# 支持其他数据库，只需修改配置
# PostgreSQL
spring.datasource.url=jdbc:postgresql://localhost:5432/relationship_app
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
```

---

## 技术支持和贡献

### 项目文档
- API文档: `http://localhost:8080/swagger-ui`
- 快速开始: [QUICK_START_GUIDE.md](QUICK_START_GUIDE.md)
- 关系目标: [RELATIONSHIP_GOALS_README.md](RELATIONSHIP_GOALS_README.md)
- Pin功能: [PIN_FEATURE_README.md](PIN_FEATURE_README.md)

### 开发团队
- 项目维护者: Ulog Team
- 技术栈: Java 17, Spring Boot 3.x, MySQL 8.x, AI (Deepseek)

### 版本历史
- v0.0.1: 初始版本
  - 用户认证系统
  - 联系人管理
  - 对话式信息收集
  - 智能问答系统
  - 关系目标管理
  - Pin收藏功能
  - 推送通知

---

## 附录

### A. 完整的环境变量清单

```bash
# 数据库
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password
DB_URL=jdbc:mysql://localhost:3306/relationship_app

# JWT
JWT_SECRET=your_jwt_secret_minimum_32_characters

# DeepSeek
DEEPSEEK_API_KEY=sk-your-deepseek-api-key

# Firebase
FIREBASE_CONFIG_PATH=/path/to/firebase-service-account.json

# 服务器
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod

# 日志
LOGGING_LEVEL_ROOT=INFO
```

### B. 数据库ER图概要

```
users (用户)
  ├── contacts (联系人)
  │     ├── conversation_sessions (对话会话)
  │     ├── relationship_goals (关系目标)
  │     │     └── action_plans (行动计划)
  │     │           └── reminders (提醒)
  │     └── pins (Pin收藏)
  ├── user_conversation_sessions (用户对话会话)
  ├── pins (Pin收藏)
  ├── refresh_tokens (刷新Token)
  └── user_push_tokens (推送Token)
```

### C. API请求示例集合

完整的Postman集合请参考：
- [complete_integrated_postman_collection.json](complete_integrated_postman_collection.json)
- [relationship_goals_api_examples.json](relationship_goals_api_examples.json)

### D. 系统架构图

```
┌─────────────┐
│  Mobile App │
└──────┬──────┘
       │ HTTPS
       ↓
┌─────────────┐
│   Nginx     │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────┐
│     Spring Boot Application     │
│  ┌───────────────────────────┐  │
│  │   Security Layer (JWT)    │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │   Controller Layer        │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │   Service Layer           │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │   Repository Layer        │  │
│  └───────────────────────────┘  │
└─────────┬───────────────────────┘
          │
    ┌─────┴─────┬──────────────┐
    ↓           ↓              ↓
┌────────┐  ┌──────────┐  ┌─────────┐
│ MySQL  │  │ Deepseek │  │Firebase │
└────────┘  │   API    │  │   FCM   │
            └──────────┘  └─────────┘
```

---

## 结语

这份技术说明文档涵盖了Relationship Management Backend系统的核心技术架构、功能模块、数据库设计、安全机制、AI集成、API接口、配置、部署和开发规范等各个方面。

该系统是一个基于AI驱动的现代化关系管理平台，通过Spring Boot 3.x、JWT认证、Deepseek AI集成、Firebase推送等技术，为用户提供智能化的人际关系管理服务。

### 核心优势
1. **AI驱动**: 深度集成Deepseek AI，提供智能对话、信息提取、策略生成等功能
2. **安全可靠**: JWT双Token机制、BCrypt加密、账户锁定保护
3. **模块化设计**: 清晰的分层架构，易于维护和扩展
4. **完善的数据管理**: Flyway版本控制，软删除机制
5. **实时提醒**: Firebase推送通知，定时任务调度
6. **RESTful API**: 标准化的API设计，完整的Swagger文档

系统已具备生产环境部署能力，可根据实际需求进行定制化开发和功能扩展。

---

**文档版本**: v1.0  
**更新日期**: 2025-10-19  
**技术栈版本**: Spring Boot 3.5.6, Java 17, MySQL 8.0

