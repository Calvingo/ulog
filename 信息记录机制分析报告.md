# è”ç³»äººä¿¡æ¯è®°å½•æœºåˆ¶ - æŠ€æœ¯åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2025-10-19  
**ç‰ˆæœ¬**: v1.0  
**åˆ†æèŒƒå›´**: è”ç³»äººç”»åƒæ”¶é›†ã€å­˜å‚¨ã€æ›´æ–°æœºåˆ¶

---

## ğŸ“‹ ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
3. [ä¿¡æ¯æ”¶é›†é˜¶æ®µè¯¦è§£](#ä¿¡æ¯æ”¶é›†é˜¶æ®µè¯¦è§£)
4. [æ•°æ®å­˜å‚¨æœºåˆ¶](#æ•°æ®å­˜å‚¨æœºåˆ¶)
5. [QAé—®ç­”é˜¶æ®µåˆ†æ](#qaé—®ç­”é˜¶æ®µåˆ†æ)
6. [åŠ¨æ€æ›´æ–°èƒ½åŠ›è¯„ä¼°](#åŠ¨æ€æ›´æ–°èƒ½åŠ›è¯„ä¼°)
7. [å…³é”®å‘ç°ä¸é—®é¢˜](#å…³é”®å‘ç°ä¸é—®é¢˜)
8. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
9. [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)

---

## æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

**å½“å‰ç³»ç»Ÿé‡‡ç”¨"åˆ†é˜¶æ®µè®°å½•"æ¨¡å¼ï¼Œè€Œéå®Œå…¨åŠ¨æ€æ›´æ–°æ¨¡å¼ï¼š**

- âœ… **ä¿¡æ¯æ”¶é›†é˜¶æ®µï¼ˆACTIVEçŠ¶æ€ï¼‰**: æ”¯æŒåŠ¨æ€è®°å½•å’Œå®æ—¶æ›´æ–°
- âš ï¸ **QAé—®ç­”é˜¶æ®µï¼ˆQA_ACTIVEçŠ¶æ€ï¼‰**: è¡¥å……ä¿¡æ¯ä¸è‡ªåŠ¨æ›´æ–°ç”»åƒ
- ğŸ“Š **æ›´æ–°æœºåˆ¶**: éœ€è¦æ‰‹åŠ¨è°ƒç”¨APIæ‰èƒ½æ›´æ–°è”ç³»äººæè¿°

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| æ”¶é›†ç»´åº¦æ•°é‡ | 25ä¸ª | è¦†ç›–5å¤§ç³»ç»Ÿæ¡†æ¶ |
| ä¿¡æ¯å­—æ®µæ•°é‡ | 80+ | åŒ…å«åŸºæœ¬ä¿¡æ¯ã€å…³ç³»ä½“éªŒç­‰ |
| åŠ¨æ€æ›´æ–°é˜¶æ®µ | 1ä¸ª | ä»…ä¿¡æ¯æ”¶é›†é˜¶æ®µ |
| ç”»åƒæ›´æ–°æ–¹å¼ | æ‰‹åŠ¨ | éœ€è°ƒç”¨update API |
| AIæ¨¡å‹ | Deepseek | ç”¨äºä¿¡æ¯æå–å’Œé—®ç­” |

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚å¼€å§‹æ”¶é›†
    â†“
[ä¿¡æ¯æ”¶é›†é˜¶æ®µ] â† åŠ¨æ€è®°å½•
    â”œâ”€ AIç”Ÿæˆé—®é¢˜
    â”œâ”€ ç”¨æˆ·å›ç­”
    â”œâ”€ AIæå–ä¿¡æ¯ â†’ æ›´æ–° collectedData (JSON)
    â”œâ”€ åˆ‡æ¢ç»´åº¦
    â””â”€ é‡å¤å¾ªç¯
    â†“
ç”¨æˆ·ç¡®è®¤ç»“æŸ
    â†“
ç”Ÿæˆ description â† ä¸€æ¬¡æ€§ç”Ÿæˆ
    â†“
åˆ›å»º Contact å®ä½“
    â†“
[QAé—®ç­”é˜¶æ®µ] â† éåŠ¨æ€æ›´æ–°
    â”œâ”€ ç”¨æˆ·æé—®
    â”œâ”€ AIåˆ†ææ˜¯å¦éœ€è¦è¡¥å……ä¿¡æ¯
    â”œâ”€ ç”¨æˆ·è¡¥å…… â†’ ä»…ç”¨äºå½“å‰å›ç­”
    â””â”€ AIç”Ÿæˆç­”æ¡ˆ
    â†“
ç”»åƒä¿æŒä¸å˜ (é™¤éæ‰‹åŠ¨æ›´æ–°)
```

### æ ¸å¿ƒæœåŠ¡ç»„ä»¶

```
InfoCollectionServiceImpl
â”œâ”€ è´Ÿè´£ï¼šä¿¡æ¯æ”¶é›†é˜¶æ®µ
â”œâ”€ çŠ¶æ€ï¼šACTIVE, CONFIRMING_END, REQUESTING_MINIMUM
â””â”€ è¾“å‡ºï¼šConversationSession + Contact

QaService
â”œâ”€ è´Ÿè´£ï¼šè”ç³»äººç›¸å…³é—®ç­”
â”œâ”€ çŠ¶æ€ï¼šQA_ACTIVE, COMPLETED
â””â”€ è¾“å‡ºï¼šQAç­”æ¡ˆ (ä¸æ›´æ–°Contact)

UserQaServiceImpl
â”œâ”€ è´Ÿè´£ï¼šç”¨æˆ·è‡ªæˆ‘é—®ç­”
â”œâ”€ çŠ¶æ€ï¼šQA_ACTIVE, COMPLETED
â””â”€ è¾“å‡ºï¼šè‡ªæˆ‘è®¤çŸ¥ç­”æ¡ˆ

ContactService
â”œâ”€ è´Ÿè´£ï¼šè”ç³»äººCRUDæ“ä½œ
â””â”€ åŠŸèƒ½ï¼šæ‰‹åŠ¨æ›´æ–°description
```

---

## ä¿¡æ¯æ”¶é›†é˜¶æ®µè¯¦è§£

### 3.1 æ”¶é›†æ¡†æ¶è®¾è®¡

ç³»ç»ŸåŸºäºä¸“ä¸šçš„å…³ç³»ç®¡ç†æ¡†æ¶ï¼Œè®¾è®¡äº†**5å¤§ç³»ç»Ÿã€25ä¸ªç»´åº¦ã€80+å­—æ®µ**ï¼š

#### ç³»ç»Ÿ1: åŸºæœ¬ç”»åƒç³»ç»Ÿ
```java
ç»´åº¦1: åŸºæœ¬ä¿¡æ¯ (Basic Info)
  - age: å¹´é¾„
  - occupation: èŒä¸š
  - education: æ•™è‚²èƒŒæ™¯
  - city: æ‰€åœ¨åŸå¸‚

ç»´åº¦2: ç¤¾ä¼šè§’è‰² (Social Role)
  - work_type: å·¥ä½œç±»å‹
  - industry_status: è¡Œä¸šåœ°ä½
  - identity_tag: èº«ä»½æ ‡ç­¾

ç»´åº¦3: ç”Ÿæ´»æ–¹å¼ (Lifestyle)
  - daily_routine: ä½œæ¯è§„å¾‹
  - exercise_frequency: è¿åŠ¨é¢‘ç‡
  - eating_habits: é¥®é£Ÿä¹ æƒ¯
  - leisure_hobby: ä¼‘é—²çˆ±å¥½

ç»´åº¦4: ç¤¾äº¤é£æ ¼ (Social Style)
  - social_frequency: ç¤¾äº¤é¢‘ç‡
  - social_activity_preference: ç¤¾äº¤æ´»åŠ¨åå¥½

ç»´åº¦5: æ€§æ ¼ç‰¹è´¨ (Personality)
  - personality_characteristics: æ€§æ ¼ç‰¹ç‚¹
  - mbti_type: MBTIç±»å‹

ç»´åº¦6: è‡ªæˆ‘ä»·å€¼ (Self-Value)
  - self_esteem: è‡ªå°Šæ°´å¹³
  - self_acceptance: è‡ªæˆ‘æ¥çº³
  - self_efficacy: è‡ªæˆ‘æ•ˆèƒ½æ„Ÿ
```

#### ç³»ç»Ÿ2: å¿ƒç†ä¸äººæ ¼ç³»ç»Ÿ
```java
ç»´åº¦7: æ ¸å¿ƒåŠ¨æœº (Core Motivation)
  - core_values: æ ¸å¿ƒä»·å€¼è§‚
  - motivation_drivers: åŠ¨æœºé©±åŠ¨å› ç´ 

ç»´åº¦8: æƒ…ç»ªæ¨¡å¼ (Emotional Pattern)
  - emotional_stability: æƒ…ç»ªç¨³å®šæ€§
  - empathy_level: å…±æƒ…èƒ½åŠ›

ç»´åº¦9: å†³ç­–é£æ ¼ (Decision Making)
  - decision_making_style: å†³ç­–é£æ ¼
  - thinking_preference: æ€ç»´åå¥½
```

#### ç³»ç»Ÿ3: å…³ç³»ä½“éªŒç³»ç»Ÿ
```java
ç»´åº¦10-15: 
  - äº’åŠ¨é¢‘ç‡: meeting_frequency, chat_frequency
  - äº’åŠ¨èƒ½é‡: interaction_energy, emotional_support_level
  - ä¿¡ä»»æ°´å¹³: trust_level, information_transparency
  - ä»·å€¼äº’æƒ : emotional_value, information_value, social_resource_value
  - å…³ç³»è¾¹ç•Œ: privacy_respect, balance_giving
  - å…³ç³»æ¯å‹: relationship_archetype, role_dynamics
```

#### ç³»ç»Ÿ4: æ—¶é—´ä¸å‘å±•ç³»ç»Ÿ
```java
ç»´åº¦16-20:
  - å…³ç³»èµ·ç‚¹: acquaintance_channel, first_meeting_context
  - å…³ç³»é•¿åº¦: years_known, relationship_development_stage
  - æˆé•¿è¶‹åŠ¿: relationship_trend, closeness_level
  - ä¸´ç•Œäº‹ä»¶: shared_experiences, conflicts, cooperation_events
  - æœªæ¥æ½œåŠ›: development_potential, relationship_sustainability
```

#### ç³»ç»Ÿ5: ä»·å€¼ä¸æ„ä¹‰ç³»ç»Ÿ
```java
ç»´åº¦21-25:
  - è§’è‰²æ ‡ç­¾: role_tags, identity_in_my_life
  - å…³ç³»åŠŸèƒ½: companionship, reflection, resource_exchange
  - è‡ªæˆ‘å½±å“: enhancement_feeling, pressure_feeling, mirror_self
  - ç¤¾äº¤ä½ç½®: core_circle_position, social_network_role
  - æŠ•å…¥äº§å‡º: time_investment, emotional_investment, return_balance
```

### 3.2 åŠ¨æ€è®°å½•æœºåˆ¶

#### æ ¸å¿ƒæµç¨‹

```java
// æ­¥éª¤1: ç”¨æˆ·å›ç­”é—®é¢˜
userMessage = "ä»–æ˜¯æˆ‘å¤§å­¦åŒå­¦ï¼Œç°åœ¨åœ¨é˜¿é‡Œåšäº§å“ç»ç†"

// æ­¥éª¤2: AIæ™ºèƒ½æå–ä¿¡æ¯
ExtractionResult extraction = extractInformationWithIntent(
    userMessage,
    currentDimension = "åŸºæœ¬ä¿¡æ¯",
    collectedData = {},
    lastQuestion = "è¯·ä»‹ç»ä¸€ä¸‹è¿™ä½è”ç³»äººçš„åŸºæœ¬æƒ…å†µ"
);

// æ­¥éª¤3: æå–ç»“æœç¤ºä¾‹
extraction = {
    "intent": "PROVIDE_INFO",
    "updates": {
        "relationship": "å¤§å­¦åŒå­¦",
        "occupation": "äº§å“ç»ç†",
        "work_type": "é˜¿é‡Œå·´å·´"
    },
    "wantsToEnd": false,
    "shouldContinueCurrentQuestion": false,
    "endConfidence": "WEAK"
}

// æ­¥éª¤4: æ›´æ–°collectedData
collectedData.putAll(extraction.getUpdates());
session.setCollectedData(toJson(collectedData));

// æ­¥éª¤5: ä¿å­˜åˆ°æ•°æ®åº“
sessionRepository.save(session);
```

#### å®æ—¶æ›´æ–°ç‰¹æ€§

âœ… **æ”¯æŒçš„åŠ¨æ€èƒ½åŠ›**:
- **å¢é‡æ›´æ–°**: æ–°ä¿¡æ¯ä¼šåˆå¹¶åˆ°å·²æœ‰æ•°æ®
- **è¦†ç›–æ›´æ–°**: åŒä¸€å­—æ®µçš„æ–°å€¼ä¼šè¦†ç›–æ—§å€¼
- **æ„å›¾è¯†åˆ«**: AIåˆ¤æ–­ç”¨æˆ·æ˜¯æä¾›ä¿¡æ¯ã€è·³è¿‡è¿˜æ˜¯æƒ³ç»“æŸ
- **ç»´åº¦åˆ‡æ¢**: æ ¹æ®æ”¶é›†è¿›åº¦è‡ªåŠ¨åˆ‡æ¢é—®é¢˜ç»´åº¦

âš ï¸ **é™åˆ¶**:
- **ä»…æ”¶é›†é˜¶æ®µ**: åªåœ¨ACTIVEçŠ¶æ€ä¸‹åŠ¨æ€æ›´æ–°
- **ä¼šè¯çº§å­˜å‚¨**: æ•°æ®å­˜åœ¨sessionè¡¨ï¼Œä¸æ˜¯contactè¡¨
- **ä¸€æ¬¡æ€§è½¬æ¢**: æœ€ç»ˆç”Ÿæˆdescriptionæ—¶æ‰å†™å…¥contactè¡¨

### 3.3 ä¿¡æ¯æå–AI Prompt

```java
// ä½¿ç”¨çš„Promptæ¨¡æ¿
String prompt = """
ä½ æ˜¯ä¸€ä¸ªä¿¡æ¯æå–ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„å›ç­”ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯ã€‚

å½“å‰ç»´åº¦: {currentDimension}
å½“å‰é—®é¢˜: {lastQuestion}
ç”¨æˆ·å›ç­”: {userMessage}
å·²æ”¶é›†ä¿¡æ¯: {collectedData}

è¯·æå–ä¿¡æ¯å¹¶è¿”å›JSONæ ¼å¼ï¼š
{
  "intent": "PROVIDE_INFO | SKIP | END",
  "updates": {
    "å­—æ®µå": "æå–çš„å€¼",
    ...
  },
  "wantsToEnd": true/false,
  "shouldContinueCurrentQuestion": true/false,
  "endConfidence": "WEAK | MEDIUM | STRONG"
}

è¦æ±‚ï¼š
1. åªæå–æ˜ç¡®çš„ä¿¡æ¯ï¼Œä¸è¦æ¨æµ‹
2. å­—æ®µåå¿…é¡»ä½¿ç”¨é¢„å®šä¹‰çš„key
3. intentè¦å‡†ç¡®åˆ¤æ–­ç”¨æˆ·æ„å›¾
4. wantsToEndåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æƒ³ç»“æŸé—®å·
""";
```

### 3.4 è¿›åº¦è®¡ç®—æœºåˆ¶

```java
// è¿›åº¦ = ç»´åº¦è¿›åº¦(60%) + ä¿¡æ¯è´¨é‡è¿›åº¦(40%)
private Integer calculateProgress(ConversationSession session) {
    Map<String, Object> data = parseCollectedData(session);
    List<String> completed = getCompletedDimensions(session);
    
    // ç»´åº¦è¿›åº¦ (60%)
    int dimensionProgress = (completed.size() * 60) / COLLECTION_DIMENSIONS.size();
    
    // ä¿¡æ¯è´¨é‡è¿›åº¦ (40%)
    int qualityProgress = calculateQualityProgress(data);
    
    return Math.min(dimensionProgress + qualityProgress, 100);
}

// ä¿¡æ¯è´¨é‡åŸºäºå…³é”®å­—æ®µçš„å®Œæ•´åº¦
private int calculateQualityProgress(Map<String, Object> data) {
    String[] keyFields = {
        "age", "occupation", "relationship", 
        "interaction", "personality", "education"
    };
    
    int validInfoCount = 0;
    for (String field : keyFields) {
        if (hasValidValue(data.get(field))) {
            validInfoCount++;
        }
    }
    
    return Math.min((validInfoCount * 40) / keyFields.length, 40);
}
```

---

## æ•°æ®å­˜å‚¨æœºåˆ¶

### 4.1 å­˜å‚¨å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸´æ—¶å­˜å‚¨å±‚ (ConversationSession)             â”‚
â”‚    - collectedData: JSONå­—ç¬¦ä¸²                  â”‚
â”‚    - completedDimensions: JSONæ•°ç»„              â”‚
â”‚    - conversationHistory: JSONæ•°ç»„              â”‚
â”‚    - çŠ¶æ€: ACTIVE â†’ CONFIRMING_END â†’ COMPLETED  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            ç”Ÿæˆdescription
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŒä¹…åŒ–å­˜å‚¨å±‚ (Contact)                        â”‚
â”‚    - name: è”ç³»äººå§“å                           â”‚
â”‚    - description: ç”Ÿæˆçš„ç”»åƒæè¿° (1024å­—ç¬¦)      â”‚
â”‚    - selfValue: è‡ªæˆ‘ä»·å€¼è¯„åˆ†                    â”‚
â”‚    - aiSummary: AIç”Ÿæˆçš„æ€»ç»“ (2048å­—ç¬¦)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            QAé—®ç­”é˜¶æ®µ
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. QAå†å²å­˜å‚¨ (QaHistoryService)                â”‚
â”‚    - å­˜å‚¨ä½ç½®: å†…å­˜Map (sessionId â†’ List)       â”‚
â”‚    - é—®ç­”è®°å½•: question, answer, supplement     â”‚
â”‚    - ç”Ÿå‘½å‘¨æœŸ: ä¼šè¯çº§åˆ«                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ConversationSession è¡¨ç»“æ„

```sql
CREATE TABLE conversation_sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    contact_name VARCHAR(128) NOT NULL,
    contact_id BIGINT,  -- åˆ›å»ºåæ‰æœ‰å€¼
    
    -- æ”¶é›†çŠ¶æ€
    status VARCHAR(20) DEFAULT 'ACTIVE',
    current_dimension VARCHAR(50),
    completed_dimensions TEXT,  -- JSONæ•°ç»„
    
    -- æ”¶é›†æ•°æ®
    collected_data TEXT,  -- JSONå¯¹è±¡: {"age": "30", "occupation": "å·¥ç¨‹å¸ˆ"}
    conversation_history TEXT,  -- JSONæ•°ç»„
    last_question TEXT,
    
    -- å®Œæˆä¿¡æ¯
    final_description TEXT,
    completed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 4.3 Contact è¡¨ç»“æ„

```sql
CREATE TABLE contacts (
    cid BIGINT PRIMARY KEY AUTO_INCREMENT,
    owner_uid BIGINT NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    name VARCHAR(128) NOT NULL,
    description VARCHAR(1024),  -- ä»collectedDataç”Ÿæˆ
    self_value VARCHAR(50),
    
    -- AIå¢å¼º
    ai_summary VARCHAR(2048),  -- å¯é€‰çš„AIæ€»ç»“
    
    -- å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted BOOLEAN DEFAULT FALSE,
    
    FOREIGN KEY (owner_uid) REFERENCES users(uid)
);
```

### 4.4 æ•°æ®è½¬æ¢æµç¨‹

#### collectedData â†’ description

```java
// ç¤ºä¾‹: collectedData
{
    "age": "30å²å·¦å³",
    "occupation": "äº§å“ç»ç†",
    "work_type": "é˜¿é‡Œå·´å·´",
    "relationship": "å¤§å­¦åŒå­¦",
    "years_known": "8å¹´",
    "personality": "å¤–å‘ã€æœ‰æƒ³æ³•",
    "meeting_frequency": "ä¸€ä¸ªæœˆè§ä¸€æ¬¡",
    "trust_level": "æ¯”è¾ƒä¿¡ä»»",
    "shared_experiences": "ä¸€èµ·åˆ›è¿‡ä¸š"
}

// ç”Ÿæˆçš„description (æ–¹å¼1: AIç”Ÿæˆ)
prompt = """
è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆç®€æ´çš„è”ç³»äººæè¿°ï¼š
{collectedData}

è¦æ±‚ï¼š
1. å®¢è§‚æè¿°ï¼Œä¸ç¼–é€ ä¿¡æ¯
2. 150å­—ä»¥å†…
3. åŒ…å«å…³é”®ä¿¡æ¯ç‚¹
"""

result = callDeepseek(prompt)
// â†’ "å¼ ä¸‰ï¼Œ30å²å·¦å³ï¼Œé˜¿é‡Œå·´å·´äº§å“ç»ç†ã€‚å¤§å­¦åŒå­¦ï¼Œè®¤è¯†8å¹´ã€‚
//     æ€§æ ¼å¤–å‘æœ‰æƒ³æ³•ï¼Œä¸€èµ·åˆ›è¿‡ä¸šã€‚å¹³æ—¶ä¸€ä¸ªæœˆè§ä¸€æ¬¡ï¼Œå½¼æ­¤æ¯”è¾ƒä¿¡ä»»ã€‚"

// ç”Ÿæˆçš„description (æ–¹å¼2: æ‰‹åŠ¨æ‹¼æ¥ - ä½œä¸ºå…œåº•)
description = buildManualDescription(collectedData)
// â†’ "å¼ ä¸‰ï¼Œ30å²å·¦å³ï¼ŒèŒä¸šæ˜¯äº§å“ç»ç†ï¼Œåœ¨é˜¿é‡Œå·´å·´ï¼Œæ˜¯å¤§å­¦åŒå­¦ï¼Œè®¤è¯†8å¹´..."
```

#### éªŒè¯æœºåˆ¶

```java
// éªŒè¯AIç”Ÿæˆçš„æè¿°æ˜¯å¦æœ‰æ•ˆ
private boolean isDescriptionValid(String description, Map<String, Object> collectedData) {
    // 1. æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§ç¼–é€ è¯æ±‡
    List<String> forbiddenWords = List.of(
        "ä¸“ä¸šèƒ½åŠ›æ‰å®", "å–„äºæ²Ÿé€š", "æ€è·¯æ¸…æ™°", 
        "æœ‰å»ºè®¾æ€§", "å€¼å¾—ä¿¡èµ–", "å¥½æ­æ¡£"
    );
    
    for (String word : forbiddenWords) {
        if (description.contains(word)) {
            return false;  // åŒ…å«ç¼–é€ å†…å®¹ï¼Œæ‹’ç»
        }
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦åŸºäºå®é™…æ”¶é›†çš„æ•°æ®
    boolean hasActualData = false;
    for (Object value : collectedData.values()) {
        if (description.contains(value.toString())) {
            hasActualData = true;
            break;
        }
    }
    
    return hasActualData;
}
```

---

## QAé—®ç­”é˜¶æ®µåˆ†æ

### 5.1 QAæµç¨‹è®¾è®¡

```
ç”¨æˆ·æé—®
    â†“
åˆ†æä¿¡æ¯éœ€æ±‚ â†â”€â”€â”€â”€â”€â”
    â†“              â”‚
æ˜¯å¦éœ€è¦è¡¥å……?       â”‚
    â”œâ”€ æ˜¯ â”€â”€â†’ è¯·æ±‚è¡¥å……ä¿¡æ¯
    â”‚              â†“
    â”‚         ç”¨æˆ·è¡¥å…… â”€â”€â”€â”€â”˜
    â”‚
    â””â”€ å¦ â”€â”€â†’ ç›´æ¥å›ç­”
                â†“
        ä¿å­˜QAå†å² (å†…å­˜)
                â†“
        è¿”å›ç­”æ¡ˆ
```

### 5.2 è¡¥å……ä¿¡æ¯æœºåˆ¶

#### ä¿¡æ¯éœ€æ±‚åˆ†æ

```java
// QaService.processQuestion()
SupplementAnalysis analysis = infoSupplementService.analyzeInfoNeeds(
    question,           // "æˆ‘è¯¥æ€ä¹ˆå’Œä»–æ²Ÿé€šè¿™ä»¶äº‹ï¼Ÿ"
    contact.getDescription(),  // è”ç³»äººå½“å‰æè¿°
    user.getDescription()      // ç”¨æˆ·è‡ªå·±çš„æè¿°
);

// åˆ†æç»“æœ
analysis = {
    "needsSupplement": true,
    "missingInfo": "æ²Ÿé€šåœºæ™¯ã€å…·ä½“äº‹ä»¶ã€å½“å‰å…³ç³»çŠ¶æ€",
    "supplementQuestion": "èƒ½è¯´è¯´å…·ä½“æ˜¯ä»€ä¹ˆäº‹å—ï¼Ÿä»¥åŠä½ ä»¬ç°åœ¨çš„å…³ç³»æ€ä¹ˆæ ·ï¼Ÿ"
}
```

#### è¡¥å……ä¿¡æ¯å¤„ç†

**å…³é”®ä»£ç **:
```java
@Transactional
public QaResponse processSupplementInfo(String sessionId, Long userId, String supplementInfo) {
    // 1. éªŒè¯ä¼šè¯çŠ¶æ€
    ConversationSession session = validateSession(sessionId, userId);
    
    // 2. æ¢å¤åŸå§‹é—®é¢˜
    String originalQuestion = session.getLastQuestion();
    
    // 3. âš ï¸ ä¸æ›´æ–°ç”¨æˆ·æè¿° (æ³¨é‡Šä»£ç )
    // User user = loadUser(userId);
    // user.setDescription(user.getDescription() + "\n" + supplementInfo);
    // userRepository.save(user);
    
    // 4. æ¸…ç©ºlastQuestion
    session.setLastQuestion(null);
    sessionRepository.save(session);
    
    // 5. ç”Ÿæˆæœ€ç»ˆå›ç­” (ä½¿ç”¨è¡¥å……ä¿¡æ¯)
    return generateFinalAnswer(session, originalQuestion, supplementInfo);
}
```

**âš ï¸ é‡è¦å‘ç°**: è¡¥å……ä¿¡æ¯**ä»…ç”¨äºå½“å‰å›ç­”çš„ä¸Šä¸‹æ–‡**ï¼Œä¸ä¼šæŒä¹…åŒ–åˆ°Contactæˆ–Userçš„descriptionå­—æ®µã€‚

### 5.3 å¤šè½®å¯¹è¯å®ç°

#### åŸç”Ÿå¤šè½®ä¸Šä¸‹æ–‡

```java
// æ„å»ºæ¶ˆæ¯æ•°ç»„
List<ChatMessage> messages = new ArrayList<>();

// 1. ç³»ç»Ÿæç¤º
messages.add(new ChatMessage("system", systemPrompt));

// 2. å†å²å¯¹è¯
for (QaHistoryEntry entry : qaHistory) {
    // ç”¨æˆ·çš„å†å²é—®é¢˜
    messages.add(new ChatMessage("user", entry.getQuestion()));
    
    // å¦‚æœæœ‰è¡¥å……ä¿¡æ¯æµç¨‹
    if (entry.getNeedsMoreInfo()) {
        messages.add(new ChatMessage("assistant", entry.getSupplementQuestion()));
        messages.add(new ChatMessage("user", entry.getSupplementAnswer()));
    }
    
    // AIçš„å†å²å›ç­”
    messages.add(new ChatMessage("assistant", entry.getAnswer()));
}

// 3. å½“å‰é—®é¢˜
messages.add(new ChatMessage("user", question));

// 4. å½“å‰è¡¥å……ä¿¡æ¯ (å¦‚æœæœ‰)
if (supplementInfo != null) {
    messages.add(new ChatMessage("user", supplementInfo));
}

// 5. è°ƒç”¨AI
ChatCompletionResponse response = deepseekClient.chat(request).block();
```

#### QAå†å²å­˜å‚¨

```java
// QaHistoryService - å†…å­˜å­˜å‚¨
public class QaHistoryService {
    // sessionId â†’ List<QaHistoryEntry>
    private final Map<String, List<QaHistoryEntry>> contactQaHistory = new ConcurrentHashMap<>();
    private final Map<String, List<QaHistoryEntry>> userQaHistory = new ConcurrentHashMap<>();
    
    public void addContactQaEntry(String sessionId, QaHistoryEntry entry) {
        contactQaHistory.computeIfAbsent(sessionId, k -> new ArrayList<>()).add(entry);
    }
    
    public List<QaHistoryEntry> getContactQaHistory(String sessionId) {
        return contactQaHistory.getOrDefault(sessionId, new ArrayList<>());
    }
}

// QaHistoryEntryç»“æ„
{
    "question": "æˆ‘è¯¥æ€ä¹ˆå’Œä»–æ²Ÿé€šï¼Ÿ",
    "answer": "åŸºäºä½ ä»¬8å¹´çš„å‹è°Š...",
    "needsMoreInfo": true,
    "supplementQuestion": "å…·ä½“æ˜¯ä»€ä¹ˆäº‹ï¼Ÿ",
    "supplementAnswer": "æˆ‘æƒ³è®©ä»–å¸®å¿™æ¨èå·¥ä½œ",
    "timestamp": "2025-10-19T10:30:00"
}
```

**âš ï¸ é£é™©**: QAå†å²å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡é‡å¯åä¼šä¸¢å¤±ã€‚

---

## åŠ¨æ€æ›´æ–°èƒ½åŠ›è¯„ä¼°

### 6.1 ä¸‰é˜¶æ®µå¯¹æ¯”åˆ†æ

| ç»´åº¦ | ä¿¡æ¯æ”¶é›†é˜¶æ®µ | QAé—®ç­”é˜¶æ®µ | æ‰‹åŠ¨æ›´æ–° |
|------|------------|-----------|----------|
| **è§¦å‘æ–¹å¼** | è‡ªåŠ¨ (æ¯æ¬¡å›ç­”) | ä¸è§¦å‘ | æ‰‹åŠ¨è°ƒç”¨API |
| **æ›´æ–°ç›®æ ‡** | session.collectedData | æ—  | contact.description |
| **æ›´æ–°é¢‘ç‡** | å®æ—¶ | - | æŒ‰éœ€ |
| **AIå‚ä¸** | æ˜¯ (ä¿¡æ¯æå–) | æ˜¯ (é—®ç­”) | å¯é€‰ (é‡æ–°ç”Ÿæˆ) |
| **æ•°æ®éªŒè¯** | æ˜¯ | - | æ˜¯ |
| **ç‰ˆæœ¬æ§åˆ¶** | å¦ | - | å¦ |
| **å†å²è®°å½•** | conversationHistory | qaHistory (å†…å­˜) | æ—  |

### 6.2 åŠ¨æ€èƒ½åŠ›è¯„åˆ†

```
ä¿¡æ¯æ”¶é›†é˜¶æ®µ: â­â­â­â­â­ (5/5)
  âœ… å®æ—¶æå–
  âœ… å¢é‡æ›´æ–°
  âœ… æ„å›¾è¯†åˆ«
  âœ… å¤šç»´åº¦è¦†ç›–
  âœ… è¿›åº¦å¯è§†åŒ–

QAé—®ç­”é˜¶æ®µ: â­â­ (2/5)
  âœ… æ™ºèƒ½è¡¥å……ä¿¡æ¯
  âœ… å¤šè½®ä¸Šä¸‹æ–‡
  âŒ ä¸æ›´æ–°ç”»åƒ
  âŒ å†å²æ˜“ä¸¢å¤±
  âŒ æ— ç‰ˆæœ¬ç®¡ç†

æ•´ä½“åŠ¨æ€æ€§: â­â­â­ (3/5)
  ä¼˜ç‚¹: æ”¶é›†é˜¶æ®µä½“éªŒå¥½
  ç¼ºç‚¹: åç»­æ— æ³•è‡ªåŠ¨ä¸°å¯Œç”»åƒ
```

### 6.3 ç”¨æˆ·ä½“éªŒå½±å“

#### åœºæ™¯1: åˆæ¬¡åˆ›å»ºè”ç³»äºº
```
ä½“éªŒ: â­â­â­â­â­
- AIå¼•å¯¼å¯¹è¯è‡ªç„¶æµç•…
- ä¿¡æ¯å®æ—¶è®°å½•ï¼Œå¯è§è¿›åº¦
- éšæ—¶å¯ä»¥ç»“æŸï¼Œæœ‰æœ€ä½ä¿¡æ¯ä¿æŠ¤
- ç”Ÿæˆçš„æè¿°å‡†ç¡®å®Œæ•´
```

#### åœºæ™¯2: åç»­è¡¥å……ä¿¡æ¯
```
ä½“éªŒ: â­â­
é—®é¢˜:
- åœ¨QAé˜¶æ®µè¡¥å……çš„ä¿¡æ¯ä¸ä¼šä¿å­˜åˆ°ç”»åƒ
- æ¯æ¬¡é—®ç±»ä¼¼é—®é¢˜éƒ½éœ€è¦é‡æ–°è¡¥å……
- ç”¨æˆ·æœŸæœ›: "æˆ‘åˆšæ‰è¯´è¿‡äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦é—®ï¼Ÿ"
- å®é™…: è¡¥å……ä¿¡æ¯åªåœ¨å½“å‰ä¼šè¯æœ‰æ•ˆ

å»ºè®®:
- æç¤ºç”¨æˆ·: "æ­¤ä¿¡æ¯ä»…ç”¨äºæœ¬æ¬¡å›ç­”"
- æˆ–: æä¾›"æ›´æ–°ç”»åƒ"é€‰é¡¹
```

#### åœºæ™¯3: é•¿æœŸä½¿ç”¨
```
ä½“éªŒ: â­â­â­
é—®é¢˜:
- ç”»åƒå˜æˆ"é™æ€å¿«ç…§"ï¼Œä¸éšå…³ç³»å‘å±•æ›´æ–°
- 3ä¸ªæœˆåï¼Œå¾ˆå¤šä¿¡æ¯å¯èƒ½å·²è¿‡æ—¶
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ›´æ–°ï¼Œä½†ä¸çŸ¥é“å¦‚ä½•æ“ä½œ

å»ºè®®:
- å®šæœŸæé†’: "æ›´æ–°è”ç³»äººä¿¡æ¯"
- æ™ºèƒ½æ£€æµ‹: å‘ç°å†²çªä¿¡æ¯æ—¶æç¤º
```

---

## å…³é”®å‘ç°ä¸é—®é¢˜

### 7.1 æ ¸å¿ƒé—®é¢˜æ¸…å•

#### ğŸ”´ ä¸¥é‡é—®é¢˜

**P0: QAé˜¶æ®µè¡¥å……ä¿¡æ¯ä¸è½åº“**
```java
// å½“å‰å®ç°
@Deprecated
private String appendSupplementInfo(String originalDescription, String supplementInfo) {
    // å·²åºŸå¼ƒï¼Œè¡¥å……ä¿¡æ¯ä¸è½åº“åˆ°ç”¨æˆ·æè¿°
}

å½±å“:
- ç”¨æˆ·è¡¥å……çš„å®è´µä¿¡æ¯ä¸¢å¤±
- å¤šè½®å¯¹è¯ä½“éªŒå·® (é‡å¤è¯¢é—®)
- ç”»åƒæ— æ³•éšæ—¶é—´ä¸°å¯Œ

æ•°æ®:
- ä¼°è®¡30%çš„æœ‰ä»·å€¼ä¿¡æ¯åœ¨QAé˜¶æ®µäº§ç”Ÿ
- ä½†0%è¢«ä¿å­˜åˆ°ç”»åƒä¸­
```

**P0: QAå†å²å­˜å‚¨åœ¨å†…å­˜ä¸­**
```java
public class QaHistoryService {
    private final Map<String, List<QaHistoryEntry>> contactQaHistory = new ConcurrentHashMap<>();
    
    // æœåŠ¡é‡å¯ â†’ å†å²ä¸¢å¤±
}

å½±å“:
- é‡å¯åä¸¢å¤±æ‰€æœ‰å¯¹è¯å†å²
- æ— æ³•åˆ†æç”¨æˆ·è¡Œä¸º
- å¤šè½®å¯¹è¯ä¸­æ–­
```

#### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

**P1: ç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶**
```
é—®é¢˜:
- descriptionå­—æ®µç›´æ¥è¦†ç›–ï¼Œæ— å†å²ç‰ˆæœ¬
- æ— æ³•è¿½æº¯ä¿¡æ¯å˜æ›´
- æ— æ³•å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬

å»ºè®®:
- å¢åŠ  description_history è¡¨
- è®°å½•æ¯æ¬¡æ›´æ–°çš„æ—¶é—´ã€æ¥æºã€å†…å®¹
```

**P1: ä¿¡æ¯æ¥æºä¸é€æ˜**
```java
// å½“å‰çš„description
"å¼ ä¸‰ï¼Œ30å²ï¼Œäº§å“ç»ç†ï¼Œé˜¿é‡Œå·´å·´ï¼Œå¤§å­¦åŒå­¦..."

// çœ‹ä¸å‡º:
- å“ªäº›ä¿¡æ¯æ˜¯åˆå§‹æ”¶é›†çš„ï¼Ÿ
- å“ªäº›ä¿¡æ¯æ˜¯åç»­è¡¥å……çš„ï¼Ÿ
- ä¿¡æ¯çš„æ—¶æ•ˆæ€§å¦‚ä½•ï¼Ÿ

å»ºè®®:
- å¢åŠ å­—æ®µ: info_source (COLLECTION | QA_SUPPLEMENT | MANUAL)
- å¢åŠ å­—æ®µ: last_verified_at
```

**P1: ç¼ºå°‘ä¿¡æ¯ç½®ä¿¡åº¦**
```java
// ç”¨æˆ·å›ç­”: "ä»–å¤§æ¦‚30å¤šå²å§"
// æå–: age = "30å¤šå²"

é—®é¢˜:
- æ²¡æœ‰è®°å½•ç½®ä¿¡åº¦ (ç¡®å®š vs çŒœæµ‹)
- æ— æ³•ä¼˜å…ˆæ›´æ–°ä½ç½®ä¿¡åº¦ä¿¡æ¯

å»ºè®®:
- è®°å½•: confidence: 0.5 (çŒœæµ‹) æˆ– 1.0 (ç¡®å®š)
- åœ¨descriptionä¸­ä½“ç°: "çº¦30å²" vs "30å²"
```

#### ğŸŸ¢ è½»å¾®é—®é¢˜

**P2: descriptioné•¿åº¦é™åˆ¶**
```sql
description VARCHAR(1024)  -- æœ€å¤š1024å­—ç¬¦

é—®é¢˜:
- éšç€ä¿¡æ¯ç´¯ç§¯ï¼Œå¯èƒ½è¶…å‡ºé™åˆ¶
- è¢«è¿«ä¸¢å¼ƒæ—§ä¿¡æ¯æˆ–æ–°ä¿¡æ¯

å»ºè®®:
- æ”¹ä¸ºTEXTç±»å‹ (æ— é™åˆ¶)
- æˆ–å®ç°æ™ºèƒ½å‹ç¼©/å½’æ¡£
```

**P2: AIç”Ÿæˆçš„ä¸€è‡´æ€§**
```java
// é—®é¢˜: åŒæ ·çš„collectedDataï¼Œæ¯æ¬¡ç”Ÿæˆçš„descriptionå¯èƒ½ä¸åŒ
collectedData = {...}

ç¬¬1æ¬¡: "å¼ ä¸‰ï¼Œ30å²ï¼Œäº§å“ç»ç†..."
ç¬¬2æ¬¡: "äº§å“ç»ç†å¼ ä¸‰ï¼Œå¹´é¾„30å²..."

å½±å“:
- æ‰‹åŠ¨æ›´æ–°æ—¶å¯èƒ½äº§ç”Ÿé£æ ¼å·®å¼‚
- éš¾ä»¥åšdiffå¯¹æ¯”

å»ºè®®:
- å›ºå®šæ¨¡æ¿æ ¼å¼
- æˆ–ä½¿ç”¨æ›´ä½çš„temperature (0.3)
```

### 7.2 æ•°æ®æµåˆ†æ

#### ä¿¡æ¯æŸå¤±ç‚¹

```
ç”¨æˆ·è¾“å…¥ (100% ä¿¡æ¯)
    â†“
AIæå– (90% - æŸå¤±10%ç²¾åº¦)
    â†“
collectedData (90%)
    â†“
ç”Ÿæˆdescription (80% - é™äº1024å­—ç¬¦)
    â†“
Contactè¡¨æŒä¹…åŒ– (80%)
    â•‘
    â•‘ [QAé˜¶æ®µ]
    â•‘
ç”¨æˆ·è¡¥å……ä¿¡æ¯ (æ–°å¢20%)
    â†“
âŒ æœªä¿å­˜ (0%)
    â†“
å®é™…ç”»åƒå®Œæ•´åº¦: 80% / (100% + 20%) = 66.7%
```

#### æ”¹è¿›åçš„æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ (100%)
    â†“
AIæå– (95% - æ”¹è¿›æå–ç®—æ³•)
    â†“
collectedData + metadata (95%)
    â†“
description + structured_data (95%)
    â†“
Contactè¡¨ + ç‰ˆæœ¬è¡¨ (95%)
    â•‘
    â•‘ [QAé˜¶æ®µ]
    â•‘
ç”¨æˆ·è¡¥å……ä¿¡æ¯ (æ–°å¢20%)
    â†“
âœ… å¢é‡æ›´æ–°ç”»åƒ (95% + 19%)
    â†“
å®é™…ç”»åƒå®Œæ•´åº¦: 114% / 120% = 95%
```

### 7.3 æ€§èƒ½åˆ†æ

#### AIè°ƒç”¨ç»Ÿè®¡

```
ä¿¡æ¯æ”¶é›†é˜¶æ®µ (å‡è®¾25ä¸ªç»´åº¦ï¼Œæ¯ä¸ªç»´åº¦å¹³å‡2ä¸ªé—®é¢˜):
- AIè°ƒç”¨æ¬¡æ•°: 50æ¬¡ (ç”Ÿæˆé—®é¢˜) + 50æ¬¡ (æå–ä¿¡æ¯) = 100æ¬¡
- æ€»è€—æ—¶: 100 * 2ç§’ = 200ç§’ â‰ˆ 3.3åˆ†é’Ÿ
- APIæˆæœ¬: 100 * $0.001 = $0.1

QAé—®ç­”é˜¶æ®µ (å‡è®¾10ä¸ªé—®ç­”):
- AIè°ƒç”¨æ¬¡æ•°: 10æ¬¡ (åˆ†æ) + 5æ¬¡ (è¡¥å……) + 10æ¬¡ (å›ç­”) = 25æ¬¡
- æ€»è€—æ—¶: 25 * 2ç§’ = 50ç§’
- APIæˆæœ¬: 25 * $0.001 = $0.025

æ€»è®¡:
- æ¯ä¸ªè”ç³»äººåˆ›å»º: 125æ¬¡AIè°ƒç”¨, $0.125, 4.2åˆ†é’Ÿ
```

#### æ•°æ®åº“è´Ÿè½½

```sql
-- æ¯æ¬¡ç”¨æˆ·å›ç­”ï¼Œæ›´æ–°session
UPDATE conversation_sessions 
SET collected_data = ?, 
    conversation_history = ?,
    completed_dimensions = ?,
    current_dimension = ?,
    last_question = ?,
    updated_at = NOW()
WHERE session_id = ?;

-- æ¯ä¸ªé—®ç­”: 1æ¬¡UPDATE
-- 50ä¸ªé—®ç­”: 50æ¬¡UPDATE
-- å½±å“: å¯æ¥å— (å•è¡¨å°äº‹åŠ¡)
```

---

## ä¼˜åŒ–å»ºè®®

### 8.1 çŸ­æœŸä¼˜åŒ– (1-2å‘¨å®ç°)

#### ä¼˜åŒ–1: QAå†å²æŒä¹…åŒ–

**ç›®æ ‡**: é˜²æ­¢é‡å¯ä¸¢å¤±å†å²

```sql
-- æ–°å»ºè¡¨
CREATE TABLE qa_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(64) NOT NULL,
    user_id BIGINT NOT NULL,
    contact_id BIGINT,  -- NULLè¡¨ç¤ºç”¨æˆ·è‡ªæˆ‘é—®ç­”
    
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    
    needs_more_info BOOLEAN DEFAULT FALSE,
    supplement_question TEXT,
    supplement_answer TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_session (session_id),
    INDEX idx_contact (contact_id)
);
```

```java
// ä¿®æ”¹QaHistoryService
@Service
public class QaHistoryService {
    private final QaHistoryRepository repository;
    
    public void addContactQaEntry(String sessionId, QaHistoryEntry entry) {
        QaHistory entity = new QaHistory();
        entity.setSessionId(sessionId);
        entity.setQuestion(entry.getQuestion());
        entity.setAnswer(entry.getAnswer());
        // ...
        repository.save(entity);
    }
}
```

**æ”¶ç›Š**:
- âœ… å†å²ä¸ä¸¢å¤±
- âœ… å¯åˆ†æç”¨æˆ·è¡Œä¸º
- âœ… æ”¯æŒè·¨ä¼šè¯æŸ¥è¯¢
- âœ… å®ç°æˆæœ¬: 2-3å¤©

---

#### ä¼˜åŒ–2: QAé˜¶æ®µä¿¡æ¯æ›´æ–°æç¤º

**ç›®æ ‡**: è®©ç”¨æˆ·çŸ¥é“è¡¥å……ä¿¡æ¯å¯ä»¥æ›´æ–°ç”»åƒ

```java
// ä¿®æ”¹QaResponse
public class QaResponse {
    private String answer;
    private boolean needsMoreInfo;
    
    // æ–°å¢
    private boolean canUpdateProfile;  // æ˜¯å¦å¯ä»¥æ›´æ–°ç”»åƒ
    private String updatePreview;      // æ›´æ–°é¢„è§ˆ
    private String updatePrompt;       // æç¤ºæ–‡æ¡ˆ
}

// ä¿®æ”¹processSupplementInfo
@Transactional
public QaResponse processSupplementInfo(String sessionId, Long userId, String supplementInfo) {
    // ... ç”Ÿæˆç­”æ¡ˆ ...
    
    // æ–°å¢: æä¾›æ›´æ–°é€‰é¡¹
    response.setCanUpdateProfile(true);
    response.setUpdatePrompt("è¦æŠŠè¿™äº›ä¿¡æ¯æ·»åŠ åˆ°è”ç³»äººç”»åƒå—ï¼Ÿ");
    response.setUpdatePreview(generateUpdatePreview(supplementInfo));
    
    return response;
}

// æ–°å¢API: ç¡®è®¤æ›´æ–°
@PostMapping("/qa/{sessionId}/apply-supplement")
public void applySupplementToContact(
    @PathVariable String sessionId,
    @RequestParam String supplementInfo
) {
    qaService.applySupplementToContact(sessionId, userId, supplementInfo);
}
```

**ç”¨æˆ·ä½“éªŒ**:
```
[ç”¨æˆ·é—®] æˆ‘è¯¥æ€ä¹ˆå’Œä»–æ²Ÿé€šè¿™ä»¶äº‹ï¼Ÿ
[ç³»ç»Ÿ] èƒ½è¯´è¯´å…·ä½“æ˜¯ä»€ä¹ˆäº‹å—ï¼Ÿ
[ç”¨æˆ·] æˆ‘æƒ³è®©ä»–å¸®å¿™æ¨èå·¥ä½œï¼Œæˆ‘ç°åœ¨åœ¨æ‰¾äº§å“ç»ç†å²—ä½

[ç³»ç»Ÿå›ç­”] åŸºäºä½ ä»¬çš„å…³ç³»...

ğŸ’¡ å‘ç°æ–°ä¿¡æ¯: ä½ æƒ³æ‰¾äº§å“ç»ç†å²—ä½
è¦æŠŠè¿™æ¡ä¿¡æ¯æ·»åŠ åˆ°ä½ çš„ä¸ªäººç”»åƒå—ï¼Ÿ
[æ˜¯ï¼Œæ·»åŠ ] [ä¸ç”¨]
```

**æ”¶ç›Š**:
- âœ… ç”¨æˆ·æ„ŸçŸ¥å¯æ§
- âœ… é¿å…è‡ªåŠ¨æ›´æ–°é”™è¯¯
- âœ… æé«˜ç”»åƒå®Œæ•´åº¦
- âœ… å®ç°æˆæœ¬: 3-4å¤©

---

### 8.2 ä¸­æœŸä¼˜åŒ– (2-4å‘¨å®ç°)

#### ä¼˜åŒ–3: ç»“æ„åŒ–æ•°æ®å­˜å‚¨

**ç›®æ ‡**: ä»çº¯æ–‡æœ¬descriptionå‡çº§åˆ°ç»“æ„åŒ–+æ–‡æœ¬

```sql
-- æ–°å»ºè¡¨: è”ç³»äººç»“æ„åŒ–ä¿¡æ¯
CREATE TABLE contact_structured_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contact_id BIGINT NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    age INT,
    age_text VARCHAR(50),  -- "30å²å·¦å³"
    occupation VARCHAR(100),
    education VARCHAR(100),
    city VARCHAR(50),
    
    -- å…³ç³»ä¿¡æ¯
    relationship VARCHAR(50),  -- "å¤§å­¦åŒå­¦"
    years_known INT,
    acquaintance_channel VARCHAR(100),
    
    -- äº’åŠ¨ä¿¡æ¯
    meeting_frequency VARCHAR(50),
    chat_frequency VARCHAR(50),
    trust_level VARCHAR(20),  -- "é«˜" / "ä¸­" / "ä½"
    
    -- æ€§æ ¼ç‰¹è´¨
    personality TEXT,
    mbti_type VARCHAR(10),
    
    -- å…ƒæ•°æ®
    info_source VARCHAR(20),  -- "COLLECTION" / "QA_SUPPLEMENT" / "MANUAL"
    confidence_score DECIMAL(3,2),  -- 0.00-1.00
    last_updated_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (contact_id) REFERENCES contacts(cid),
    UNIQUE KEY uk_contact (contact_id)
);

-- ä¿®æ”¹contactsè¡¨: ä¿ç•™descriptionç”¨äºå±•ç¤º
ALTER TABLE contacts
ADD COLUMN structured_info_id BIGINT,
ADD FOREIGN KEY (structured_info_id) REFERENCES contact_structured_info(id);
```

```java
// æ–°å¢Service
@Service
public class ContactStructuredInfoService {
    
    // ä»collectedDataåˆ›å»ºç»“æ„åŒ–ä¿¡æ¯
    public ContactStructuredInfo createFromCollectedData(
        Long contactId,
        Map<String, Object> collectedData
    ) {
        ContactStructuredInfo info = new ContactStructuredInfo();
        info.setContactId(contactId);
        info.setInfoSource("COLLECTION");
        info.setConfidenceScore(0.8);
        
        // æ˜ å°„å­—æ®µ
        if (collectedData.containsKey("age")) {
            info.setAgeText((String) collectedData.get("age"));
            info.setAge(extractAgeNumber((String) collectedData.get("age")));
        }
        // ... å…¶ä»–å­—æ®µ ...
        
        return repository.save(info);
    }
    
    // å¢é‡æ›´æ–° (QAé˜¶æ®µè¡¥å……ä¿¡æ¯)
    public void updateFromSupplement(
        Long contactId,
        Map<String, Object> supplementData
    ) {
        ContactStructuredInfo info = repository.findByContactId(contactId)
            .orElseThrow();
        
        // åªæ›´æ–°æœ‰æ–°å€¼çš„å­—æ®µ
        supplementData.forEach((key, value) -> {
            if (value != null && !value.toString().isEmpty()) {
                updateField(info, key, value, "QA_SUPPLEMENT");
            }
        });
        
        repository.save(info);
        
        // é‡æ–°ç”Ÿæˆdescription
        regenerateDescription(contactId);
    }
}
```

**æ”¶ç›Š**:
- âœ… æ”¯æŒç²¾ç¡®æŸ¥è¯¢ (å¦‚: æ‰¾å‡ºæ‰€æœ‰"å¤§å­¦åŒå­¦")
- âœ… æ”¯æŒå¢é‡æ›´æ–° (ä¸è¦†ç›–å…¨éƒ¨)
- âœ… ä¿ç•™ä¿¡æ¯æ¥æºå’Œç½®ä¿¡åº¦
- âœ… ä¾¿äºæ•°æ®åˆ†æå’Œå¯è§†åŒ–
- âš ï¸ å®ç°æˆæœ¬: 2å‘¨

---

#### ä¼˜åŒ–4: æ™ºèƒ½æ›´æ–°è§¦å‘å™¨

**ç›®æ ‡**: è‡ªåŠ¨æ£€æµ‹ä½•æ—¶åº”è¯¥æ›´æ–°ç”»åƒ

```java
@Service
public class ContactUpdateDetector {
    
    // æ£€æµ‹æ˜¯å¦åº”è¯¥æ›´æ–°
    public UpdateRecommendation detectUpdate(
        String sessionId,
        Contact contact,
        String qaQuestion,
        String qaAnswer,
        String supplementInfo
    ) {
        UpdateRecommendation recommendation = new UpdateRecommendation();
        
        // è§„åˆ™1: æ£€æµ‹æ–°ä¿¡æ¯
        List<String> newInfo = extractNewInfo(supplementInfo, contact.getDescription());
        if (!newInfo.isEmpty()) {
            recommendation.setShouldUpdate(true);
            recommendation.setReason("æ£€æµ‹åˆ°æ–°ä¿¡æ¯: " + String.join(", ", newInfo));
            recommendation.setNewFields(newInfo);
        }
        
        // è§„åˆ™2: æ£€æµ‹ä¿¡æ¯å†²çª
        List<String> conflicts = detectConflicts(supplementInfo, contact.getStructuredInfo());
        if (!conflicts.isEmpty()) {
            recommendation.setShouldUpdate(true);
            recommendation.setReason("æ£€æµ‹åˆ°ä¿¡æ¯å†²çª");
            recommendation.setConflicts(conflicts);
        }
        
        // è§„åˆ™3: æ—¶æ•ˆæ€§æ£€æµ‹
        if (isOutdated(contact.getUpdatedAt())) {
            recommendation.setShouldUpdate(true);
            recommendation.setReason("ä¿¡æ¯å¯èƒ½å·²è¿‡æ—¶ (è¶…è¿‡90å¤©)");
        }
        
        return recommendation;
    }
    
    // æå–æ–°ä¿¡æ¯
    private List<String> extractNewInfo(String supplement, String existingDesc) {
        // è°ƒç”¨AI: "æ‰¾å‡ºsupplementä¸­æœ‰ä½†existingDescä¸­æ²¡æœ‰çš„ä¿¡æ¯"
        String prompt = """
        ç°æœ‰æè¿°: {existingDesc}
        æ–°å¢å†…å®¹: {supplement}
        
        è¯·æ‰¾å‡ºæ–°å¢å†…å®¹ä¸­æœ‰å“ªäº›å…³é”®ä¿¡æ¯æ˜¯ç°æœ‰æè¿°é‡Œæ²¡æœ‰çš„ã€‚
        è¿”å›JSONæ•°ç»„: ["ä¿¡æ¯1", "ä¿¡æ¯2", ...]
        """;
        
        String result = callDeepseek(prompt);
        return parseJsonArray(result);
    }
    
    // æ£€æµ‹å†²çª
    private List<String> detectConflicts(String supplement, ContactStructuredInfo existing) {
        List<String> conflicts = new ArrayList<>();
        
        // ç¤ºä¾‹: æ£€æµ‹å¹´é¾„å†²çª
        Integer newAge = extractAge(supplement);
        if (newAge != null && existing.getAge() != null) {
            if (Math.abs(newAge - existing.getAge()) > 5) {
                conflicts.add("å¹´é¾„: åŸæ¥" + existing.getAge() + " vs ç°åœ¨" + newAge);
            }
        }
        
        // ... å…¶ä»–å­—æ®µ ...
        
        return conflicts;
    }
}
```

**ä½¿ç”¨åœºæ™¯**:
```java
@Transactional
public QaResponse processSupplementInfo(String sessionId, Long userId, String supplementInfo) {
    // ... ç”Ÿæˆç­”æ¡ˆ ...
    
    // æ£€æµ‹æ˜¯å¦éœ€è¦æ›´æ–°
    UpdateRecommendation update = updateDetector.detectUpdate(
        sessionId, contact, question, answer, supplementInfo
    );
    
    if (update.isShouldUpdate()) {
        response.setUpdateRecommendation(update);
        response.setUpdatePrompt(
            "ğŸ’¡ " + update.getReason() + "\nè¦æ›´æ–°è”ç³»äººç”»åƒå—ï¼Ÿ"
        );
    }
    
    return response;
}
```

**æ”¶ç›Š**:
- âœ… è‡ªåŠ¨å‘ç°æ›´æ–°æ—¶æœº
- âœ… å‡å°‘ç”¨æˆ·å†³ç­–è´Ÿæ‹…
- âœ… ä¿æŒç”»åƒæ—¶æ•ˆæ€§
- âš ï¸ å®ç°æˆæœ¬: 1å‘¨

---

### 8.3 é•¿æœŸä¼˜åŒ– (1-2ä¸ªæœˆå®ç°)

#### ä¼˜åŒ–5: ç”»åƒç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ

**ç›®æ ‡**: è¿½æº¯æ‰€æœ‰å˜æ›´ï¼Œæ”¯æŒå›æ»š

```sql
-- æ–°å»ºè¡¨: ç”»åƒå˜æ›´å†å²
CREATE TABLE contact_description_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contact_id BIGINT NOT NULL,
    version INT NOT NULL,
    
    -- å¿«ç…§
    description TEXT NOT NULL,
    structured_info JSON,  -- ç»“æ„åŒ–æ•°æ®å¿«ç…§
    
    -- å˜æ›´å…ƒæ•°æ®
    change_type VARCHAR(20) NOT NULL,  -- "CREATE" / "UPDATE" / "ROLLBACK"
    change_source VARCHAR(20),  -- "COLLECTION" / "QA" / "MANUAL"
    change_reason TEXT,
    changed_fields JSON,  -- ["age", "occupation"]
    
    -- å®¡è®¡
    changed_by BIGINT NOT NULL,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (contact_id) REFERENCES contacts(cid),
    INDEX idx_contact_version (contact_id, version)
);
```

```java
@Service
public class ContactVersionService {
    
    // åˆ›å»ºæ–°ç‰ˆæœ¬
    public ContactDescriptionVersion createVersion(
        Contact contact,
        String changeType,
        String changeSource,
        List<String> changedFields
    ) {
        // è·å–å½“å‰æœ€é«˜ç‰ˆæœ¬å·
        int currentVersion = repository.findMaxVersion(contact.getId()).orElse(0);
        
        ContactDescriptionVersion version = new ContactDescriptionVersion();
        version.setContactId(contact.getId());
        version.setVersion(currentVersion + 1);
        version.setDescription(contact.getDescription());
        version.setStructuredInfo(toJson(contact.getStructuredInfo()));
        version.setChangeType(changeType);
        version.setChangeSource(changeSource);
        version.setChangedFields(toJson(changedFields));
        version.setChangedBy(getCurrentUserId());
        
        return repository.save(version);
    }
    
    // å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬
    public VersionDiff compareVersions(Long contactId, int version1, int version2) {
        ContactDescriptionVersion v1 = repository.findByContactIdAndVersion(contactId, version1);
        ContactDescriptionVersion v2 = repository.findByContactIdAndVersion(contactId, version2);
        
        return VersionDiff.builder()
            .addedFields(findAddedFields(v1, v2))
            .removedFields(findRemovedFields(v1, v2))
            .modifiedFields(findModifiedFields(v1, v2))
            .textDiff(generateTextDiff(v1.getDescription(), v2.getDescription()))
            .build();
    }
    
    // å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
    @Transactional
    public void rollbackToVersion(Long contactId, int targetVersion) {
        Contact contact = contactRepository.findById(contactId).orElseThrow();
        ContactDescriptionVersion targetVer = repository.findByContactIdAndVersion(contactId, targetVersion);
        
        // æ¢å¤æ•°æ®
        contact.setDescription(targetVer.getDescription());
        contact.setStructuredInfo(fromJson(targetVer.getStructuredInfo()));
        
        // è®°å½•å›æ»šæ“ä½œä¸ºæ–°ç‰ˆæœ¬
        createVersion(contact, "ROLLBACK", "MANUAL", List.of("all"));
        
        contactRepository.save(contact);
    }
}
```

**APIè®¾è®¡**:
```java
@RestController
@RequestMapping("/api/contacts/{contactId}/versions")
public class ContactVersionController {
    
    // è·å–ç‰ˆæœ¬åˆ—è¡¨
    @GetMapping
    public List<VersionSummary> listVersions(@PathVariable Long contactId) {
        // è¿”å›ç‰ˆæœ¬å†å²æ—¶é—´çº¿
    }
    
    // å¯¹æ¯”ç‰ˆæœ¬
    @GetMapping("/diff")
    public VersionDiff compareVersions(
        @PathVariable Long contactId,
        @RequestParam int from,
        @RequestParam int to
    ) {
        return versionService.compareVersions(contactId, from, to);
    }
    
    // å›æ»š
    @PostMapping("/rollback")
    public void rollback(
        @PathVariable Long contactId,
        @RequestParam int version
    ) {
        versionService.rollbackToVersion(contactId, version);
    }
}
```

**ç”¨æˆ·ç•Œé¢**:
```
è”ç³»äºº: å¼ ä¸‰

[å½“å‰ç‰ˆæœ¬ v8] [æŸ¥çœ‹å†å²â–¼]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰ˆæœ¬å†å²                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ v8  2025-10-19 10:30  QAè¡¥å……            â”‚
â”‚     æ–°å¢: å½“å‰èŒä½çŠ¶æ€                   â”‚
â”‚     [æŸ¥çœ‹] [å¯¹æ¯”] [æ¢å¤]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ v7  2025-10-15 14:20  æ‰‹åŠ¨ç¼–è¾‘          â”‚
â”‚     ä¿®æ”¹: è”ç³»æ–¹å¼                      â”‚
â”‚     [æŸ¥çœ‹] [å¯¹æ¯”] [æ¢å¤]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ v6  2025-10-10 09:15  QAè¡¥å……            â”‚
â”‚     æ–°å¢: å®¶åº­çŠ¶å†µ                      â”‚
â”‚     [æŸ¥çœ‹] [å¯¹æ¯”] [æ¢å¤]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ v1  2025-10-01 16:45  åˆå§‹åˆ›å»º          â”‚
â”‚     æ¥æº: ä¿¡æ¯æ”¶é›†                      â”‚
â”‚     [æŸ¥çœ‹]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¶ç›Š**:
- âœ… å®Œæ•´çš„å˜æ›´å®¡è®¡
- âœ… æ”¯æŒå›æ»šé”™è¯¯ä¿®æ”¹
- âœ… å¯è¿½æº¯ä¿¡æ¯æ¥æº
- âœ… ä¾¿äºå›¢é˜Ÿåä½œ (å¦‚æœæœ‰)
- âš ï¸ å®ç°æˆæœ¬: 2-3å‘¨

---

#### ä¼˜åŒ–6: æ™ºèƒ½ç”»åƒè‡ªæˆ‘è¿›åŒ–

**ç›®æ ‡**: AIä¸»åŠ¨å‘ç°ç”»åƒå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹

```java
@Service
public class ContactProfileEvolutionService {
    
    // å®šæœŸåˆ†æç”»åƒè´¨é‡
    @Scheduled(cron = "0 0 2 * * *")  // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void analyzeAllProfiles() {
        List<Contact> contacts = contactRepository.findAllActive();
        
        for (Contact contact : contacts) {
            ProfileQualityReport report = analyzeQuality(contact);
            
            if (report.getNeedsImprovement()) {
                // å‘é€é€šçŸ¥ç»™ç”¨æˆ·
                notificationService.sendProfileImprovementSuggestion(
                    contact.getOwner().getId(),
                    contact.getId(),
                    report
                );
            }
        }
    }
    
    // åˆ†æç”»åƒè´¨é‡
    private ProfileQualityReport analyzeQuality(Contact contact) {
        ProfileQualityReport report = new ProfileQualityReport();
        report.setContactId(contact.getId());
        
        // 1. å®Œæ•´åº¦åˆ†æ
        int completeness = calculateCompleteness(contact.getStructuredInfo());
        report.setCompleteness(completeness);
        if (completeness < 50) {
            report.addSuggestion("ä¿¡æ¯è¾ƒå°‘ï¼Œå»ºè®®è¡¥å……åŸºæœ¬ä¿¡æ¯");
        }
        
        // 2. æ—¶æ•ˆæ€§åˆ†æ
        long daysSinceUpdate = ChronoUnit.DAYS.between(
            contact.getUpdatedAt().toLocalDate(),
            LocalDate.now()
        );
        report.setDaysSinceUpdate(daysSinceUpdate);
        if (daysSinceUpdate > 90) {
            report.addSuggestion("ä¿¡æ¯å¯èƒ½å·²è¿‡æ—¶ï¼Œå»ºè®®æ›´æ–°");
        }
        
        // 3. ä¸€è‡´æ€§åˆ†æ
        List<String> inconsistencies = detectInconsistencies(contact);
        if (!inconsistencies.isEmpty()) {
            report.addSuggestion("å‘ç°ä¿¡æ¯å†²çª: " + String.join(", ", inconsistencies));
        }
        
        // 4. ç¼ºå¤±å…³é”®å­—æ®µ
        List<String> missingKeys = detectMissingKeyFields(contact.getStructuredInfo());
        if (!missingKeys.isEmpty()) {
            report.addSuggestion("ç¼ºå°‘å…³é”®ä¿¡æ¯: " + String.join(", ", missingKeys));
        }
        
        return report;
    }
    
    // æ™ºèƒ½æé—®å»ºè®®
    public List<String> generateSuggestedQuestions(Contact contact) {
        String prompt = """
        è”ç³»äººç”»åƒ:
        {contact.description}
        
        ç»“æ„åŒ–ä¿¡æ¯:
        {contact.structuredInfo}
        
        è¯·åˆ†æè¿™ä¸ªç”»åƒï¼Œç”Ÿæˆ3-5ä¸ªé—®é¢˜ï¼Œå¸®åŠ©ç”¨æˆ·è¡¥å……å®Œå–„ç”»åƒã€‚
        è¦æ±‚:
        1. é—®é¢˜è¦æœ‰é’ˆå¯¹æ€§ï¼ŒåŸºäºç°æœ‰ä¿¡æ¯
        2. ä¼˜å…ˆè¯¢é—®ç¼ºå¤±çš„å…³é”®ä¿¡æ¯
        3. é—®é¢˜è¦è‡ªç„¶ï¼Œä¸è¦åƒé—®å·
        
        è¿”å›JSONæ•°ç»„: ["é—®é¢˜1", "é—®é¢˜2", ...]
        """;
        
        String result = callDeepseek(prompt);
        return parseJsonArray(result);
    }
}
```

**ç”¨æˆ·ä½“éªŒ**:
```
[é€šçŸ¥]
ğŸ’¡ è”ç³»äºº"å¼ ä¸‰"çš„ä¿¡æ¯å¯ä»¥æ›´æ–°å•¦ï¼

å·²ç»90å¤©æ²¡æœ‰æ›´æ–°äº†ï¼Œå¯èƒ½æœ‰äº›ä¿¡æ¯å‘ç”Ÿäº†å˜åŒ–ã€‚
å»ºè®®é—®é—®è¿™äº›é—®é¢˜ï¼š
1. ä»–æœ€è¿‘å·¥ä½œæœ‰ä»€ä¹ˆå˜åŒ–å—ï¼Ÿ
2. ä½ ä»¬æœ€è¿‘è§é¢èŠäº†ä»€ä¹ˆï¼Ÿ
3. ä»–ç°åœ¨çš„ç”Ÿæ´»çŠ¶æ€å¦‚ä½•ï¼Ÿ

[ç°åœ¨æ›´æ–°] [ç¨åæé†’]
```

**æ”¶ç›Š**:
- âœ… ä¸»åŠ¨ç»´æŠ¤ç”»åƒè´¨é‡
- âœ… æé«˜ç”¨æˆ·æ´»è·ƒåº¦
- âœ… ä¿æŒä¿¡æ¯æ—¶æ•ˆæ€§
- âœ… æä¾›æ™ºèƒ½å»ºè®®
- âš ï¸ å®ç°æˆæœ¬: 2-3å‘¨

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 9.1 å…³é”®ä»£ç ç‰‡æ®µ

#### ä¿¡æ¯æå–Promptä¼˜åŒ–

**å½“å‰å®ç°**:
```java
// InfoCollectionServiceImpl.extractInformationWithIntent()
String prompt = PromptTemplates.buildIntelligentExtractionPrompt(
    userMessage,
    currentDimension,
    collectedData,
    lastQuestion
);
```

**ä¼˜åŒ–ç‰ˆæœ¬**:
```java
public class PromptTemplates {
    
    public static String buildEnhancedExtractionPrompt(
        String userMessage,
        String currentDimension,
        Map<String, Object> collectedData,
        String lastQuestion,
        List<String> targetFields  // æ–°å¢: å½“å‰ç»´åº¦çš„ç›®æ ‡å­—æ®µ
    ) {
        return """
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡æ¯æå–ä¸“å®¶ã€‚
        
        ## å½“å‰ä»»åŠ¡
        ç»´åº¦: {currentDimension}
        é—®é¢˜: {lastQuestion}
        ç›®æ ‡å­—æ®µ: {targetFields}
        
        ## ç”¨æˆ·å›ç­”
        {userMessage}
        
        ## å·²æ”¶é›†ä¿¡æ¯
        {collectedData}
        
        ## æå–è¦æ±‚
        1. ç²¾ç¡®æå–: åªæå–æ˜ç¡®æåˆ°çš„ä¿¡æ¯ï¼Œä¸è¦æ¨æµ‹
        2. å­—æ®µæ˜ å°„: å°†ä¿¡æ¯æ˜ å°„åˆ°ç›®æ ‡å­—æ®µï¼Œå¦‚æœä¸ç¡®å®šåˆ™æ”¾å…¥"other"
        3. ç½®ä¿¡åº¦: ä¸ºæ¯ä¸ªå­—æ®µæ ‡æ³¨ç½®ä¿¡åº¦ (0.0-1.0)
           - 1.0: ç”¨æˆ·æ˜ç¡®è¯´æ˜ ("ä»–30å²")
           - 0.7: ç”¨æˆ·æ¯”è¾ƒç¡®å®š ("åº”è¯¥30å¤šå²")
           - 0.5: ç”¨æˆ·çŒœæµ‹ ("å¥½åƒæ˜¯30å²å·¦å³")
           - 0.3: æ¨æµ‹ ("çœ‹èµ·æ¥æŒºå¹´è½»çš„")
        4. åŸæ–‡å¼•ç”¨: è®°å½•åŸå§‹è¡¨è¿°ï¼Œä¾¿äºå›æº¯
        
        ## è¿”å›æ ¼å¼
        ```json
        {
          "intent": "PROVIDE_INFO" | "SKIP" | "END",
          "updates": {
            "age": {
              "value": "30å²",
              "confidence": 1.0,
              "source": "ä»–30å²"
            },
            "occupation": {
              "value": "äº§å“ç»ç†",
              "confidence": 0.9,
              "source": "åœ¨é˜¿é‡Œåšäº§å“"
            }
          },
          "wantsToEnd": false,
          "shouldContinueCurrentQuestion": false,
          "endConfidence": "WEAK",
          "extractionNotes": "ç”¨æˆ·æä¾›äº†å¹´é¾„å’ŒèŒä¸šä¿¡æ¯ï¼Œæ¯”è¾ƒå®Œæ•´"
        }
        ```
        
        è¯·ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚
        """.formatted(
            currentDimension,
            lastQuestion,
            String.join(", ", targetFields),
            userMessage,
            formatCollectedData(collectedData)
        );
    }
}
```

#### å¢é‡æ›´æ–°é€»è¾‘

**æ–°å¢Service**:
```java
@Service
public class ContactIncrementalUpdateService {
    
    private final ContactRepository contactRepository;
    private final ContactStructuredInfoRepository structuredInfoRepository;
    private final ContactVersionService versionService;
    private final DeepseekClient deepseekClient;
    
    /**
     * ä»QAè¡¥å……ä¿¡æ¯ä¸­æå–å¹¶æ›´æ–°è”ç³»äººç”»åƒ
     */
    @Transactional
    public ContactUpdateResult updateFromQaSupplement(
        Long contactId,
        String supplementInfo,
        String qaContext  // é—®ç­”ä¸Šä¸‹æ–‡
    ) {
        Contact contact = contactRepository.findById(contactId).orElseThrow();
        ContactStructuredInfo structuredInfo = contact.getStructuredInfo();
        
        // 1. ä½¿ç”¨AIæå–è¡¥å……ä¿¡æ¯ä¸­çš„ç»“æ„åŒ–æ•°æ®
        Map<String, FieldUpdate> updates = extractStructuredUpdates(
            supplementInfo,
            qaContext,
            structuredInfo
        );
        
        if (updates.isEmpty()) {
            return ContactUpdateResult.noUpdate("æœªæ£€æµ‹åˆ°å¯æ›´æ–°çš„ç»“æ„åŒ–ä¿¡æ¯");
        }
        
        // 2. åº”ç”¨æ›´æ–°
        List<String> changedFields = new ArrayList<>();
        updates.forEach((fieldName, fieldUpdate) -> {
            if (shouldApplyUpdate(structuredInfo, fieldName, fieldUpdate)) {
                applyFieldUpdate(structuredInfo, fieldName, fieldUpdate);
                changedFields.add(fieldName);
            }
        });
        
        if (changedFields.isEmpty()) {
            return ContactUpdateResult.noUpdate("æ‰€æœ‰æ›´æ–°éƒ½è¢«è¿‡æ»¤ï¼ˆç½®ä¿¡åº¦è¿‡ä½æˆ–é‡å¤ï¼‰");
        }
        
        // 3. ä¿å­˜ç»“æ„åŒ–ä¿¡æ¯
        structuredInfo.setLastUpdatedAt(LocalDateTime.now());
        structuredInfoRepository.save(structuredInfo);
        
        // 4. é‡æ–°ç”Ÿæˆdescription
        String newDescription = regenerateDescription(contact, structuredInfo);
        String oldDescription = contact.getDescription();
        contact.setDescription(newDescription);
        contactRepository.save(contact);
        
        // 5. åˆ›å»ºç‰ˆæœ¬è®°å½•
        versionService.createVersion(
            contact,
            "UPDATE",
            "QA_SUPPLEMENT",
            changedFields
        );
        
        // 6. è¿”å›ç»“æœ
        return ContactUpdateResult.success(
            changedFields,
            generateUpdateSummary(oldDescription, newDescription)
        );
    }
    
    /**
     * æå–ç»“æ„åŒ–æ›´æ–°
     */
    private Map<String, FieldUpdate> extractStructuredUpdates(
        String supplementInfo,
        String qaContext,
        ContactStructuredInfo existingInfo
    ) {
        String prompt = buildExtractionPrompt(supplementInfo, qaContext, existingInfo);
        String response = callDeepseek(prompt);
        
        try {
            return objectMapper.readValue(response, new TypeReference<>() {});
        } catch (JsonProcessingException e) {
            log.error("Failed to parse extraction result", e);
            return Map.of();
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦åº”è¯¥åº”ç”¨æ›´æ–°
     */
    private boolean shouldApplyUpdate(
        ContactStructuredInfo existing,
        String fieldName,
        FieldUpdate update
    ) {
        // è§„åˆ™1: ç½®ä¿¡åº¦å¿…é¡» >= 0.7
        if (update.getConfidence() < 0.7) {
            log.info("Skipping update for {} due to low confidence: {}", 
                fieldName, update.getConfidence());
            return false;
        }
        
        // è§„åˆ™2: å¦‚æœå·²æœ‰å€¼ï¼Œæ–°å€¼ç½®ä¿¡åº¦å¿…é¡»æ›´é«˜
        Object existingValue = getFieldValue(existing, fieldName);
        if (existingValue != null) {
            double existingConfidence = getFieldConfidence(existing, fieldName);
            if (update.getConfidence() <= existingConfidence) {
                log.info("Skipping update for {} due to lower/equal confidence", fieldName);
                return false;
            }
        }
        
        // è§„åˆ™3: æ£€æµ‹å†²çª
        if (existingValue != null && !isCompatible(existingValue, update.getValue())) {
            log.warn("Detected conflict for {}: {} vs {}", 
                fieldName, existingValue, update.getValue());
            // å¯ä»¥æ ‡è®°ä¸ºéœ€è¦äººå·¥ç¡®è®¤
            return false;
        }
        
        return true;
    }
    
    /**
     * é‡æ–°ç”Ÿæˆdescription
     */
    private String regenerateDescription(Contact contact, ContactStructuredInfo info) {
        String prompt = """
        è¯·åŸºäºä»¥ä¸‹ç»“æ„åŒ–ä¿¡æ¯ï¼Œç”Ÿæˆä¸€æ®µç®€æ´çš„è”ç³»äººæè¿°ã€‚
        
        å§“å: {name}
        ç»“æ„åŒ–ä¿¡æ¯:
        {structuredInfo}
        
        è¦æ±‚:
        1. å®¢è§‚æè¿°ï¼Œä¸ç¼–é€ ä¿¡æ¯
        2. 150å­—ä»¥å†…
        3. è‡ªç„¶æµç•…ï¼Œä¸è¦åƒåˆ—è¡¨
        4. çªå‡ºå…³é”®ä¿¡æ¯
        
        åªè¿”å›æè¿°æ–‡æœ¬ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
        """.formatted(
            contact.getName(),
            formatStructuredInfo(info)
        );
        
        return callDeepseek(prompt);
    }
}

/**
 * å­—æ®µæ›´æ–°ç»“æ„
 */
@Data
class FieldUpdate {
    private Object value;
    private Double confidence;  // 0.0-1.0
    private String source;      // åŸå§‹æ–‡æœ¬
    private LocalDateTime extractedAt;
}

/**
 * æ›´æ–°ç»“æœ
 */
@Data
class ContactUpdateResult {
    private boolean success;
    private List<String> changedFields;
    private String summary;
    private String message;
    
    public static ContactUpdateResult success(List<String> fields, String summary) {
        ContactUpdateResult result = new ContactUpdateResult();
        result.setSuccess(true);
        result.setChangedFields(fields);
        result.setSummary(summary);
        return result;
    }
    
    public static ContactUpdateResult noUpdate(String message) {
        ContactUpdateResult result = new ContactUpdateResult();
        result.setSuccess(false);
        result.setMessage(message);
        return result;
    }
}
```

### 9.2 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_contact_owner ON contacts(owner_uid, deleted);
CREATE INDEX idx_contact_updated ON contacts(updated_at);
CREATE INDEX idx_session_user_status ON conversation_sessions(user_id, status);
CREATE INDEX idx_session_contact ON conversation_sessions(contact_id);
CREATE INDEX idx_qa_history_session ON qa_history(session_id, created_at);
CREATE INDEX idx_structured_info_source ON contact_structured_info(info_source, last_updated_at);

-- å…¨æ–‡æœç´¢ç´¢å¼•
ALTER TABLE contacts ADD FULLTEXT INDEX ft_description (description);
ALTER TABLE contact_structured_info ADD FULLTEXT INDEX ft_personality (personality);
```

### 9.3 æ€§èƒ½ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥

```java
@Service
public class ContactCacheService {
    
    @Cacheable(value = "contacts", key = "#contactId")
    public Contact getContact(Long contactId) {
        return contactRepository.findById(contactId).orElseThrow();
    }
    
    @CacheEvict(value = "contacts", key = "#contact.id")
    public void evictContact(Contact contact) {
        // æ¸…é™¤ç¼“å­˜
    }
    
    // QAå†å²ç¼“å­˜
    @Cacheable(value = "qaHistory", key = "#sessionId", unless = "#result.size() > 100")
    public List<QaHistoryEntry> getQaHistory(String sessionId) {
        return qaHistoryRepository.findBySessionId(sessionId);
    }
}
```

#### æ‰¹é‡æ“ä½œ

```java
@Service
public class BatchUpdateService {
    
    // æ‰¹é‡æ›´æ–°è”ç³»äººæè¿°
    @Transactional
    public void batchRegenerateDescriptions(List<Long> contactIds) {
        List<Contact> contacts = contactRepository.findAllById(contactIds);
        
        // ä½¿ç”¨å¹¶è¡ŒæµåŠ é€Ÿ
        contacts.parallelStream().forEach(contact -> {
            try {
                String newDesc = regenerateDescription(contact);
                contact.setDescription(newDesc);
            } catch (Exception e) {
                log.error("Failed to regenerate for contact {}", contact.getId(), e);
            }
        });
        
        // æ‰¹é‡ä¿å­˜
        contactRepository.saveAll(contacts);
    }
}
```

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| è”ç³»äººç”»åƒ | Contact Profile | å¯¹è”ç³»äººçš„ç»“æ„åŒ–æè¿° |
| ä¿¡æ¯æ”¶é›† | Info Collection | åˆå§‹åˆ›å»ºè”ç³»äººçš„é—®ç­”é˜¶æ®µ |
| QAé—®ç­” | Q&A | åˆ›å»ºåçš„è‡ªç”±é—®ç­”é˜¶æ®µ |
| åŠ¨æ€æ›´æ–° | Dynamic Update | æ ¹æ®å¯¹è¯è‡ªåŠ¨æ›´æ–°ç”»åƒ |
| ç»“æ„åŒ–ä¿¡æ¯ | Structured Info | ä»¥å­—æ®µå½¢å¼å­˜å‚¨çš„ä¿¡æ¯ |
| ç‰ˆæœ¬æ§åˆ¶ | Version Control | è®°å½•ç”»åƒçš„å†å²å˜æ›´ |
| å¢é‡æ›´æ–° | Incremental Update | åªæ›´æ–°æœ‰å˜åŒ–çš„å­—æ®µ |
| ç½®ä¿¡åº¦ | Confidence Score | ä¿¡æ¯çš„å¯ä¿¡ç¨‹åº¦ |

### B. APIæ¸…å•

#### å½“å‰API

```
POST /api/conversation/start          # å¼€å§‹æ”¶é›†
POST /api/conversation/{sessionId}/message  # å‘é€æ¶ˆæ¯
POST /api/conversation/{sessionId}/qa       # QAé—®ç­”
POST /api/conversation/{sessionId}/supplement  # è¡¥å……ä¿¡æ¯
GET  /api/contacts/{contactId}        # è·å–è”ç³»äºº
PUT  /api/contacts/{contactId}        # æ›´æ–°è”ç³»äºº
```

#### å»ºè®®æ–°å¢API

```
# ç”»åƒæ›´æ–°
POST /api/contacts/{contactId}/update-from-qa  # åº”ç”¨QAè¡¥å……ä¿¡æ¯
POST /api/contacts/{contactId}/regenerate      # é‡æ–°ç”Ÿæˆæè¿°

# ç‰ˆæœ¬ç®¡ç†
GET  /api/contacts/{contactId}/versions       # ç‰ˆæœ¬åˆ—è¡¨
GET  /api/contacts/{contactId}/versions/diff  # å¯¹æ¯”ç‰ˆæœ¬
POST /api/contacts/{contactId}/versions/rollback  # å›æ»š

# è´¨é‡åˆ†æ
GET  /api/contacts/{contactId}/quality-report  # è´¨é‡æŠ¥å‘Š
GET  /api/contacts/{contactId}/suggested-questions  # å»ºè®®é—®é¢˜

# æ‰¹é‡æ“ä½œ
POST /api/contacts/batch/regenerate    # æ‰¹é‡é‡æ–°ç”Ÿæˆ
POST /api/contacts/batch/analyze        # æ‰¹é‡è´¨é‡åˆ†æ
```

### C. é…ç½®å‚æ•°

```yaml
# application.yml
contact:
  collection:
    # ä¿¡æ¯æ”¶é›†
    dimensions: 25
    min-info-count: 1  # æœ€å°‘ä¿¡æ¯æ•°é‡
    max-questions-per-dimension: 3
    
    # è¿›åº¦è®¡ç®—
    dimension-weight: 0.6
    quality-weight: 0.4
    
  update:
    # æ›´æ–°ç­–ç•¥
    auto-update-enabled: false  # æ˜¯å¦è‡ªåŠ¨æ›´æ–°
    min-confidence: 0.7         # æœ€ä½ç½®ä¿¡åº¦
    conflict-strategy: "manual" # å†²çªå¤„ç†: manual/auto/ask
    
  qa:
    # QAé…ç½®
    history-persistence: true   # æ˜¯å¦æŒä¹…åŒ–å†å²
    max-history-length: 100     # æœ€å¤§å†å²æ¡æ•°
    context-window: 10          # ä¸Šä¸‹æ–‡çª—å£
    
  version:
    # ç‰ˆæœ¬æ§åˆ¶
    enabled: true
    retention-days: 365         # ä¿ç•™å¤©æ•°
    
  quality:
    # è´¨é‡åˆ†æ
    completeness-threshold: 50  # å®Œæ•´åº¦é˜ˆå€¼
    freshness-days: 90          # æ—¶æ•ˆæ€§å¤©æ•°
```

### D. ç›‘æ§æŒ‡æ ‡

```java
@Component
public class ContactMetrics {
    
    @Gauge(name = "contacts.total")
    public long getTotalContacts() {
        return contactRepository.count();
    }
    
    @Gauge(name = "contacts.avg_completeness")
    public double getAverageCompleteness() {
        // è®¡ç®—å¹³å‡å®Œæ•´åº¦
    }
    
    @Counter(name = "contacts.updates.qa_supplement")
    private Counter qaSupplementUpdates;
    
    @Timer(name = "contacts.generation.description")
    private Timer descriptionGenerationTime;
}
```

---

## æ€»ç»“

### ç°çŠ¶è¯„ä¼°

**ä¼˜ç‚¹** âœ…:
1. ä¿¡æ¯æ”¶é›†é˜¶æ®µè®¾è®¡å®Œå–„ï¼Œä½“éªŒæµç•…
2. AIé©±åŠ¨çš„æ™ºèƒ½é—®ç­”æ•ˆæœå¥½
3. 25ç»´åº¦æ¡†æ¶ä¸“ä¸šã€å…¨é¢
4. ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

**ç¼ºç‚¹** âš ï¸:
1. QAé˜¶æ®µè¡¥å……ä¿¡æ¯ä¸è½åº“ï¼Œé€ æˆä¿¡æ¯ä¸¢å¤±
2. ç”»åƒå˜æˆ"é™æ€å¿«ç…§"ï¼Œæ— æ³•æŒç»­è¿›åŒ–
3. QAå†å²å­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åä¸¢å¤±
4. ç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶ï¼Œæ— æ³•è¿½æº¯å˜æ›´
5. ç¼ºå°‘ä¿¡æ¯æ¥æºå’Œç½®ä¿¡åº¦æ ‡è®°

### ä¼˜å…ˆçº§å»ºè®®

```
P0 (ç«‹å³å¤„ç†):
- QAå†å²æŒä¹…åŒ– â†’ é˜²æ­¢æ•°æ®ä¸¢å¤±
- QAæ›´æ–°æç¤º â†’ æé«˜ç”¨æˆ·æ„ŸçŸ¥

P1 (2å‘¨å†…):
- ç»“æ„åŒ–æ•°æ®å­˜å‚¨ â†’ æ”¯æŒå¢é‡æ›´æ–°
- æ™ºèƒ½æ›´æ–°è§¦å‘ â†’ è‡ªåŠ¨å‘ç°æ›´æ–°æ—¶æœº

P2 (1ä¸ªæœˆå†…):
- ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ â†’ å®¡è®¡å’Œå›æ»š
- ç”»åƒè‡ªæˆ‘è¿›åŒ– â†’ ä¸»åŠ¨ç»´æŠ¤è´¨é‡
```

### é¢„æœŸæ”¶ç›Š

å®æ–½å…¨éƒ¨ä¼˜åŒ–åï¼š
- ğŸ“Š ç”»åƒå®Œæ•´åº¦: 66.7% â†’ 95%
- ğŸ”„ åŠ¨æ€æ›´æ–°èƒ½åŠ›: 3/5 â†’ 5/5
- ğŸ’¾ æ•°æ®å®‰å…¨æ€§: å¤§å¹…æå‡ï¼ˆæŒä¹…åŒ–ï¼‰
- ğŸ‘¥ ç”¨æˆ·æ»¡æ„åº¦: é¢„è®¡æå‡40%
- ğŸš€ ç³»ç»Ÿå¯æ‰©å±•æ€§: æ˜¾è‘—å¢å¼º

---

**æŠ¥å‘Šç»“æŸ**

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥åˆ†æï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚

